<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Pago - GamingKings</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    <style>
        /* Estilos para el botón de copiar y el mensaje */
        .copy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .copy-container .wallet-address {
            display: none; /* Oculta la dirección real */
        }
        .copy-button {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        /* Estilos generales (pueden venir de style.css, pero se incluyen aquí para que funcione) */
        :root {
            --primary-color: #8A2BE2; /* Morado azulado */
            --button-text-color: #FFFFFF; /* Blanco */
            --secondary-pink: #FF69B4; /* Rosa vibrante */
            --card-bg: #2D2D2D; /* Gris oscuro */
            --text-color: #E0E0E0; /* Texto claro */
            --primary-color-dark: #6A1E9E; /* Tono más oscuro del morado principal */
            --background-color: #1a1a2e; /* Fondo oscuro */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #16213e;
            padding: 1rem 0;
            border-bottom: 2px solid var(--primary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        .logo-img {
            height: 50px;
        }
        main {
            flex: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background-color: #0f3460;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }
        .payment-container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            margin: 2rem auto;
            text-align: center;
        }
        .game-payment-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 15px;
        }
        .game-payment-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }
        .game-payment-header h1 {
            font-size: 2.2em;
            color: var(--secondary-pink);
            margin: 0;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.7);
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
        }
        .detail-item:last-child {
            border-bottom: none;
        }
        .detail-item span:first-child {
            font-weight: bold;
            color: var(--primary-color);
        }
        .detail-item span:last-child {
            color: var(--text-color);
        }
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #444;
            background-color: #333;
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 1em;
        }
        .form-group input[type="file"] {
            padding: 0.5rem;
            background-color: #444;
            cursor: pointer;
        }
        .form-group input[type="file"]::file-selector-button {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .form-group input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-color-dark);
        }
        .payment-method-info {
            background-color: #1f4068;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--secondary-pink);
            text-align: left;
        }
        .payment-method-info p {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .payment-method-info strong {
            color: var(--secondary-pink);
        }
        .finalize-btn {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 2rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            font-weight: bold;
        }
        .finalize-btn:hover {
            background-color: var(--primary-color-dark);
            transform: translateY(-2px);
        }
        .finalize-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .success-message {
            background-color: #1f4068;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            color: #4CAF50; /* Verde para éxito */
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        .whatsapp-message-container, .tiktok-message-container {
            background-color: #1f4068;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-top: 2rem;
            border: 1px solid var(--secondary-pink);
        }
        .whatsapp-message-container p, .tiktok-message-container p {
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        .whatsapp-link {
            display: inline-block;
            background-color: #25D366;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .whatsapp-link:hover {
            background-color: #1DA851;
        }
        .tiktok-copy-button {
            background-color: #000; /* Negro para TikTok */
            color: white;
            border: 1px solid #EE1D52; /* Rojo TikTok */
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        .tiktok-copy-button:hover {
            background-color: #333;
        }
        footer {
            background-color: #16213e;
            color: var(--text-color);
            text-align: center;
            padding: 1rem 0;
            border-top: 2px solid var(--primary-color);
            margin-top: 20px;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .footer-links a {
            color: var(--secondary-pink);
            text-decoration: none;
            margin: 0 10px;
        }
        .footer-links a:hover {
            text-decoration: underline;
        }
        .whatsapp-link-footer {
            display: inline-block;
            margin-top: 10px;
            background-color: #25D366;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
        }
        .whatsapp-link-footer:hover {
            background-color: #1DA851;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-payment-header h1 {
                font-size: 1.8em;
            }
            .payment-container {
                padding: 1.5rem;
                margin: 1rem auto;
            }
        }
        @media (max-width: 480px) {
            .game-payment-header img {
                width: 60px;
                height: 60px;
            }
            .game-payment-header h1 {
                font-size: 1.5em;
            }
            .finalize-btn {
                font-size: 1em;
                padding: 0.6rem 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="index.html" class="logo-link">
                <img src="images/gamingkings_logo.png" alt="GamingKings Logo" class="logo-img">
            </a>
        </div>
        <!-- Puedes añadir el search bar y el currency selector aquí si los necesitas en payment.html -->
        <div class="header-right">
            <!-- Espacio para elementos adicionales en el header si los necesitas -->
        </div>
    </header>

    <main>
        <div class="payment-container">
            <div id="gamePaymentHeader" class="game-payment-header">
                <img id="gameLogo" src="" alt="Game Logo">
                <h1 id="gameNameDisplay"></h1>
            </div>

            <h2 class="text-2xl font-bold text-white mb-4">Detalles de la Recarga</h2>
            
            <div class="mb-6 text-left">
                <div class="detail-item">
                    <span>Paquete:</span>
                    <span id="packageNameDisplay"></span>
                </div>
                <div class="detail-item">
                    <span>Total a Pagar:</span>
                    <span id="finalPriceDisplay"></span>
                </div>
            </div>

            <form id="paymentForm" class="text-left">
                <div class="form-group">
                    <label for="email">Correo Electrónico:</label>
                    <input type="email" id="email" name="email" placeholder="tu@ejemplo.com" required class="w-full">
                </div>
                <div class="form-group">
                    <label for="fullName">Nombre Completo:</label>
                    <input type="text" id="fullName" name="fullName" placeholder="Tu Nombre Completo" required class="w-full">
                </div>
                <div class="form-group">
                    <label for="whatsappNumber">Número de WhatsApp (con código de país):</label>
                    <input type="text" id="whatsappNumber" name="whatsappNumber" placeholder="+584123456789" required class="w-full">
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Método de Pago:</label>
                    <select id="paymentMethod" name="paymentMethod" class="w-full p-2 border rounded">
                        <option value="">Selecciona un método de pago</option>
                        <option value="pago-movil">Pago Móvil (Venezuela)</option>
                        <option value="binance">Binance (USDT TRC20)</option>
                        <option value="zinli">Zinli</option>
                        <option value="zelle">Zelle</option>
                    </select>
                </div>

                <div id="paymentMethodInfo" class="payment-method-info">
                    <p>Por favor, selecciona un método de pago para ver los detalles.</p>
                </div>

                <div class="form-group mt-4">
                    <label for="paymentReceipt">Comprobante de Pago (captura de pantalla):</label>
                    <input type="file" id="paymentReceipt" name="paymentReceipt" accept="image/*" class="w-full">
                </div>

                <button type="submit" id="finalizeBtn" class="finalize-btn">Finalizar Recarga</button>
            </form>

            <!-- Mensaje de éxito -->
            <div id="successMessage" class="success-message hidden">
                <p>¡Solicitud de recarga enviada con éxito!</p>
                <p>Te enviaremos una confirmación por WhatsApp pronto.</p>
            </div>

            <!-- Mensaje específico para TikTok -->
            <div id="tiktokMessageContainer" class="tiktok-message-container hidden">
                <h2 class="text-xl font-bold text-white mb-2">¡Importante para TikTok!</h2>
                <p class="mb-2">Por favor, realiza la recarga a la siguiente cuenta de TikTok:</p>
                <p class="text-lg font-bold text-yellow-400 mb-2">Usuario TikTok: <span id="tiktokAccountDisplay"></span></p>
                <p class="text-lg font-bold text-green-400 mb-2">Paquete: <span id="tiktokPackageDisplay"></span></p>
                <p class="text-lg font-bold text-blue-400 mb-4">Monto: <span id="tiktokPriceDisplay"></span></p>
                <div class="copy-container justify-center">
                    <span class="wallet-address" id="tiktokWalletAddress">GamingKingsRecargas</span> <!-- Dirección o nombre de usuario real de TikTok -->
                    <button type="button" class="tiktok-copy-button">Copiar Usuario TikTok</button>
                </div>
                <p class="mt-4">Una vez realizado el pago, nuestro equipo verificará y procesará tu recarga.</p>
            </div>

            <!-- Mensaje de WhatsApp (ahora solo se muestra si es necesario, después de procesar) -->
            <div id="whatsappMessageContainer" class="whatsapp-message-container hidden">
                <p>¡Tu recarga ha sido recibida!</p>
                <p>Te enviaremos los detalles y la confirmación por WhatsApp.</p>
                <a id="whatsappLinkDisplay" href="#" target="_blank" class="whatsapp-link">Abrir WhatsApp</a>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 GamingKings. Todos los derechos reservados.</p>
            <div class="footer-links">
                <a href="privacy.html">Políticas de Privacidad</a>
                <a href="terms.html">Términos de Servicio</a>
            </div>
            <a href="https://wa.me/573021090841" target="_blank" class="whatsapp-link-footer">
                <i class="fab fa-whatsapp"></i> Contáctanos por WhatsApp
            </a>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Configuración de Supabase (¡REEMPLAZA ESTO CON TUS PROPIAS CLAVES!)
        const SUPABASE_URL = 'TU_SUPABASE_URL'; 
        const SUPABASE_ANON_KEY = 'TU_SUPABASE_ANON_KEY'; 

        // Inicializa Supabase Client de forma global
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized globally."); // Para depuración
        
        const paymentDetailsTemplates = {
            'pago-movil': `
                <p><strong>Paso 1:</strong> Realiza el Pago Móvil a los siguientes datos:</p>
                <ul>
                    <li><strong>Banco:</strong> Banco de Venezuela (0102)</li>
                    <li><strong>Cédula/RIF:</strong> V-31605458</li>
                    <li><strong>Teléfono:</strong> 0412-7123391</li>
                </ul>
                <div class="payment-fields-container">
                    <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                    <label for="payment-receipt">Subir Comprobante de Pago:</label>
                    <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
                </div>
            `,
            'binance': `
                <p><strong>Paso 1:</strong> Realiza la transferencia a nuestra cuenta Binance (USDT BEP20) O (Binance Pay).</p>
                <ul>
                    <p><strong>USDT (BEP20):</strong></p>
                    <li>
                        <div class="copy-container">
                            <span class="address-label">Dirección de Billetera BEP20:</span>
                            <span class="wallet-address" id="binance-address">0x9ebe5fe682123c531408944236a99754886a46dd</span>
                            <button type="button" class="copy-button" data-copy-target="binance-address">Copiar</button>
                            <span class="copy-feedback" id="binance-copy-feedback">¡Copiado!</span>
                        </div>
                    </li>
                    <li><strong>Moneda:</strong> USDT (BEP20)</li>
                    <p><strong>Binance Pay:</strong></p>
                    <li><strong>ID Binance Pay:</strong> 909792776</li>
                </ul>
                <div class="payment-fields-container">
                    <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                    <label for="payment-receipt">Subir Comprobante de Pago:</label>
                    <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
                </div>
            `,
            'zinli': `
                <p><strong>Paso 1:</strong> Transfiere el monto exacto a nuestra cuenta Zinli.</p>
                <ul>
                    <li><strong>Usuario Zinli:</strong> endryreyes199@gmail.com</li>
                </ul>
                <div class="payment-fields-container">
                    <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                    <label for="payment-receipt">Subir Comprobante de Pago:</label>
                    <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
                </div>
            `
        };

        const paymentMethodsVES = [
            { id: 'pago-movil', name: 'Pago Móvil', type: 'ves', icon: 'fas fa-mobile-alt' }
        ];

        const paymentMethodsUSD = [
            { id: 'binance', name: 'Binance', type: 'usd', icon: 'fab fa-bitcoin' },
            { id: 'zinli', name: 'Zinli', type: 'usd', icon: 'fas fa-wallet' }
        ];

        let transactionDetails = null;
        const paymentForm = document.getElementById('payment-form');
        const whatsappMessageContainer = document.getElementById('whatsapp-message-container');
        const finalizeBtn = document.getElementById('finalize-recharge-btn');
        const successMessageDisplay = document.getElementById('success-message-display'); 
        const gamePaymentHeader = document.getElementById('game-payment-header'); // Nuevo elemento
        const gameBannerDisplay = document.getElementById('gameBannerDisplay'); // Nuevo elemento
        const gameTitleDisplay = document.getElementById('gameTitleDisplay'); // Nuevo elemento

        document.addEventListener('DOMContentLoaded', () => {
            const transactionSummaryDiv = document.getElementById('transaction-summary');
            const paymentMethodsDiv = document.getElementById('payment-methods');
            const paymentDetailsFormDiv = document.getElementById('payment-details-form');
            
            const storedDetails = localStorage.getItem('transactionDetails');
            if (storedDetails) {
                transactionDetails = JSON.parse(storedDetails);
                updateGameHeader(); // Llamada a la nueva función
                updateTransactionSummary();
                updatePaymentMethods();

                if (transactionDetails.game === "TikTok") {
                    whatsappMessageContainer.style.display = 'block';
                    finalizeBtn.style.display = 'none';
                    // El email ya no es requerido por defecto en el HTML, por lo que no hace falta setearlo aquí.
                } else {
                    whatsappMessageContainer.style.display = 'none';
                    finalizeBtn.style.display = 'block';
                }

            } else {
                transactionSummaryDiv.innerHTML = '<p>No se encontraron detalles de la transacción. Por favor, regresa a la página de inicio.</p>';
                finalizeBtn.style.display = 'none';
                whatsappMessageContainer.style.display = 'none';
                gamePaymentHeader.style.display = 'none'; // Oculta el header si no hay detalles
            }

            // Nueva función para actualizar el encabezado del juego
            function updateGameHeader() {
                if (transactionDetails && transactionDetails.game) {
                    gamePaymentHeader.style.display = 'block';
                    gameTitleDisplay.textContent = `Confirmar Recarga para ${transactionDetails.game}`;
                    if (transactionDetails.gameBanner) {
                        gameBannerDisplay.src = transactionDetails.gameBanner;
                        gameBannerDisplay.style.display = 'block';
                    } else {
                        gameBannerDisplay.style.display = 'none'; // Oculta si no hay banner
                    }
                } else {
                    gamePaymentHeader.style.display = 'none';
                }
            }

            function updateTransactionSummary() {
                if (!transactionDetails) return;

                const displayAmount = parseFloat(transactionDetails.finalPrice);
                const displayCurrency = transactionDetails.currency;
                
                let otherCurrencyDisplay = '';
                if (transactionDetails.priceUSD && transactionDetails.priceVES) {
                    if (displayCurrency === 'VES') {
                        otherCurrencyDisplay = ` (~ $${parseFloat(transactionDetails.priceUSD).toFixed(2)} USD)`;
                    } else if (displayCurrency === 'USD') {
                        otherCurrencyDisplay = ` (~ Bs. ${parseFloat(transactionDetails.priceVES).toFixed(2)} VES)`;
                    }
                }

                const playerIdHtml = transactionDetails.playerId ? `<p><strong>ID de Jugador:</strong> ${transactionDetails.playerId}</p>` : '';

                transactionSummaryDiv.innerHTML = `
                    <p><strong>Juego:</strong> ${transactionDetails.game}</p>
                    ${playerIdHtml}
                    <p><strong>Plan Seleccionado:</strong> ${transactionDetails.package}</p>
                    <p><strong>Total a Pagar:</strong> <span class="amount">${displayCurrency === 'VES' ? 'Bs.' : '$'} ${displayAmount.toFixed(2)} ${displayCurrency}</span>${otherCurrencyDisplay}</p>
                    <p>Por favor, realiza el pago por el monto exacto y selecciona tu método a continuación.</p>
                `;
            }

            function updatePaymentMethods() {
                paymentMethodsDiv.innerHTML = '';
                const currentCurrency = transactionDetails.currency;
                const methods = currentCurrency === 'VES' ? paymentMethodsVES : paymentMethodsUSD;

                methods.forEach(method => {
                    const methodItem = document.createElement('div');
                    methodItem.classList.add('payment-method-option');
                    methodItem.innerHTML = `
                        <input type="radio" id="method-${method.id}" name="paymentMethod" value="${method.id}" data-type="${method.type}">
                        <label for="method-${method.id}">
                            <i class="${method.icon}"></i>
                            <span>${method.name}</span>
                        </label>
                    `;
                    paymentMethodsDiv.appendChild(methodItem);
                });

                paymentMethodsDiv.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        const selectedMethodId = event.target.value;
                        loadPaymentDetails(selectedMethodId);
                        checkFormValidity();
                    });
                });
                checkFormValidity();
            }

            function loadPaymentDetails(methodId) {
                let methodHtml = paymentDetailsTemplates[methodId];

                if (methodHtml) {
                    paymentDetailsFormDiv.innerHTML = methodHtml;

                    if (transactionDetails.game === "TikTok") {
                        const fieldsContainer = paymentDetailsFormDiv.querySelector('.payment-fields-container');
                        if (fieldsContainer) {
                            fieldsContainer.style.display = 'none'; // Oculta la subida del comprobante para TikTok
                        }
                    } else {
                        // Only add event listener for the file input if it's not TikTok
                        const fileInput = document.getElementById('payment-receipt');
                        if (fileInput) {
                            fileInput.addEventListener('change', checkFormValidity);
                            // El atributo 'required' ya está en el template HTML de paymentDetailsTemplates,
                            // por lo que no es necesario setearlo aquí, pero no hace daño.
                            fileInput.required = true; 
                        }
                    }

                    const copyButton = paymentDetailsFormDiv.querySelector('.copy-button');
                    if (copyButton) {
                        copyButton.addEventListener('click', handleCopyButtonClick);
                    }

                } else {
                    paymentDetailsFormDiv.innerHTML = '<p>Selecciona un método de pago para ver los detalles.</p>';
                }
                checkFormValidity();

                // Add event listeners to email and whatsapp inputs for validity check
                document.getElementById('email').addEventListener('input', checkFormValidity);
                // Attach listener to both countryCode and whatsappNumber inputs
                document.getElementById('countryCode').addEventListener('change', checkFormValidity); 
                document.getElementById('whatsappNumber').addEventListener('input', checkFormValidity);
            }

            async function handleCopyButtonClick(event) {
                const button = event.currentTarget;
                const targetId = button.dataset.copyTarget;
                const textToCopyElement = document.getElementById(targetId);
                const feedbackElement = document.getElementById(`${targetId}-copy-feedback`);

                if (textToCopyElement && navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(textToCopyElement.textContent);
                        if (feedbackElement) {
                            feedbackElement.textContent = '¡Copiado!';
                            feedbackElement.style.display = 'inline-block';
                            setTimeout(() => {
                                feedbackElement.style.display = 'none';
                            }, 1500);
                        }
                    } catch (err) {
                        console.error('Error al copiar: ', err);
                        if (feedbackElement) {
                            feedbackElement.textContent = 'Error al copiar';
                            feedbackElement.style.display = 'inline-block';
                            setTimeout(() => {
                                feedbackElement.style.display = 'none';
                            }, 1500);
                        }
                        alert('No se pudo copiar el texto. Por favor, cópialo manualmente.');
                    }
                } else {
                    alert('Tu navegador no soporta la copia automática o no se encontró el elemento. Por favor, selecciona y copia la dirección manualmente.');
                }
            }

            function checkFormValidity() {
                const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
                const isMethodSelected = selectedRadio !== null;
                
                // Get values from the country code and whatsapp number inputs
                const countryCodeInput = document.getElementById('countryCode');
                const whatsappInput = document.getElementById('whatsappNumber');
                
                // WhatsApp is now required, ensure both parts are filled
                const isWhatsappFilled = whatsappInput && whatsappInput.value.trim() !== '';
                const isCountryCodeSelected = countryCodeInput && countryCodeInput.value.trim() !== '' && countryCodeInput.value !== ''; // Also check if a valid option is selected

                // Combined check for WhatsApp number including country code
                const isFullWhatsappValid = isWhatsappFilled && isCountryCodeSelected;
                
                // The email field is optional, only check validity IF filled
                const emailInput = document.getElementById('email');
                const isEmailValidIfFilled = (!emailInput || emailInput.value.trim() === '' || emailInput.checkValidity());

                let areDetailsFilled = true;

                if (transactionDetails && transactionDetails.game === "TikTok") {
                    // For TikTok, payment receipt is not required, but WhatsApp is
                    areDetailsFilled = isFullWhatsappValid; 
                } else if (isMethodSelected) {
                    // For other games, payment receipt AND WhatsApp are required
                    const fileInput = document.getElementById('payment-receipt');
                    if (fileInput && fileInput.files.length === 0) {
                        areDetailsFilled = false;
                    }
                    // Combine with full WhatsApp validity
                    areDetailsFilled = areDetailsFilled && isFullWhatsappValid;
                } else {
                    areDetailsFilled = false;
                }
                
                // The finalize button is enabled if:
                // 1. A method is selected (unless TikTok, where no receipt)
                // 2. Payment details (receipt) are filled (if applicable) AND WhatsApp is fully filled.
                // 3. Email is valid (if filled).
                if (transactionDetails.game !== "TikTok") {
                    finalizeBtn.disabled = !(isMethodSelected && areDetailsFilled && isEmailValidIfFilled);
                } else {
                    // For TikTok, the button depends on WhatsApp being fully filled and email being valid if filled
                    finalizeBtn.disabled = !(isFullWhatsappValid && isEmailValidIfFilled); 
                }
            }


            document.getElementById('payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                // Get values from the country code and whatsapp number inputs
                const countryCode = document.getElementById('countryCode').value;
                const whatsappNumberInput = document.getElementById('whatsappNumber').value.trim();
                const fullWhatsappNumber = countryCode + whatsappNumberInput; // Combine them here

                // Get form data using FormData API
                const formData = new FormData(paymentForm);

                // Update the whatsappNumber in formData with the combined value
                formData.set('whatsappNumber', fullWhatsappNumber);
                // INICIO DE MODIFICACIÓN: Lógica para obtener user_id de Supabase y asignarlo a playerId
                let currentUserId = null;
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session && session.user) {
                        currentUserId = session.user.id;
                        console.log("Supabase User ID (from payment.html):", currentUserId);
                    } else {
                        console.warn("No hay sesión de usuario activa en Supabase en payment.html. El playerId para KingsCoins será 'anon'.");
                    }
                } catch (error) {
                    console.error("Error al obtener la sesión de Supabase en payment.html:", error);
                }

                // Si el juego es KingCoins, usa el user_id de Supabase como playerId
                if (transactionDetails.game === "KingsCoins") {
                    formData.append('playerId', currentUserId || 'anon'); // Usa 'anon' si no hay user_id
                } else {
                    // Para otros juegos, usa el playerId original de la transacción
                    // Asegúrate de que transactionDetails.playerId exista para otros juegos
                    formData.append('playerId', transactionDetails.playerId || ''); 
                }
                // FIN DE MODIFICACIÓN
                

                // Add transactionDetails to formData (these are not direct form inputs)
                for (const key in transactionDetails) {
                    // Avoid re-appending whatsappNumber if it's already set from the combined value
                    if (key === 'whatsappNumber' || key === 'playerId') continue; 
                    formData.append(key, transactionDetails[key]);
                }

                // New: Check if WhatsApp is fully filled (now required)
                if (!whatsappNumberInput || !countryCode || countryCode === "") { // Added check for empty countryCode
                    alert('Por favor, ingresa tu número de WhatsApp y selecciona el prefijo del país para poder contactarte.');
                    // You might want to focus on the problematic input, e.g., whatsappNumber or countryCode
                    if (!countryCode || countryCode === "") document.getElementById('countryCode').focus();
                    else document.getElementById('whatsappNumber').focus();
                    return;
                }

                // El email es opcional, solo se valida si está lleno
                const emailInput = document.getElementById('email');
                if (emailInput && emailInput.value.trim() !== '' && !emailInput.checkValidity()) {
                    alert('Por favor, ingresa un correo electrónico válido si deseas recibir la factura.');
                    emailInput.focus();
                    return;
                }
                
                // Check for payment receipt if it's not a TikTok game
                if (transactionDetails.game !== "TikTok") {
                    const paymentReceipt = document.getElementById('payment-receipt');
                    if (!paymentReceipt || paymentReceipt.files.length === 0) {
                        alert('Por favor, sube tu comprobante de pago.');
                        return;
                    }
                }

                // Log FormData entries for debugging (not the file content itself)
                console.log('Datos a enviar (FormData):');
                for (let pair of formData.entries()) {
                   console.log(pair[0]+ ': ' + pair[1]);
                }
                
                // Disable button and show loading message
                finalizeBtn.disabled = true;
                finalizeBtn.textContent = 'Enviando...';
                
                try {
                    // Send FormData directly; fetch will set Content-Type header to multipart/form-data automatically
                    const response = await fetch('/.netlify/functions/process-payment', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // Show success message and hide form
                        paymentForm.style.display = 'none';
                        whatsappMessageContainer.style.display = 'none'; // Hide TikTok specific message if shown
                        successMessageDisplay.style.display = 'block';
                        gamePaymentHeader.style.display = 'none'; // Oculta el encabezado del juego al completar

                        localStorage.removeItem('transactionDetails'); // Clear stored details

                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 5000); // 5 seconds
                    } else {
                        const errorData = await response.json();
                        alert(`Ocurrió un error: ${errorData.message || response.statusText}. Por favor, verifica tus datos e inténtalo de nuevo.`);
                        console.error('Server error:', errorData);
                        finalizeBtn.disabled = false;
                        finalizeBtn.textContent = 'Finalizar Recarga';
                    }
                } catch (error) {
                    alert('Hubo un problema de conexión. Por favor, inténtalo de nuevo más tarde.');
                    console.error('Network or client error:', error);
                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = 'Finalizar Recarga';
                }
            });
        });
    </script>
</body>
</html>
