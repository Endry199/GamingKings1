<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Pago - GamingKings</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos para el botón de copiar y el mensaje */
        .copy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .copy-container .wallet-address {
            display: none; /* Oculta la dirección real */
        }
        .copy-button {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .copy-button:hover {
            background-color: #0056b3;
        }
        .copy-feedback {
            display: none;
            margin-left: 10px;
            color: #28a745;
            font-size: 0.9em;
            font-weight: bold;
        }
        /* Estilo para la etiqueta de la dirección */
        .address-label {
            font-weight: bold;
            color: var(--text-color);
        }
        /* Estilo para los nuevos campos de correo y whatsapp */
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        .input-group input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-background);
            color: var(--text-color);
            box-sizing: border-box; /* Asegura que el padding no aumente el ancho */
        }
        /* Estilo para el mensaje de éxito */
        .payment-success-message {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--accent-green-light); /* Un color de fondo suave para el éxito */
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            text-align: center;
            color: var(--accent-green); /* Color del texto */
        }
        .payment-success-message h2 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .payment-success-message p {
            margin-bottom: 0;
        }
        /* Estilos para los pasos */
        .form-section-step {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .form-section-step h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        /* Nuevo estilo para el header del juego en la página de pago */
        .game-payment-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .game-payment-header img {
            width: 100%;
            max-height: 200px; /* Ajusta la altura máxima para banners */
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .game-payment-header h2 {
            margin-top: 0;
            color: var(--heading-color);
            font-size: 2em;
        }

        /* payment.html - Estilos para el selector de prefijo de país */
        .phone-input-group {
            display: flex;
            gap: 10px; /* Espacio entre el selector de país y el input */
            align-items: center;
        }

        .phone-input-group .country-code-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-background); /* Usar la variable existente */
            color: var(--text-color);
            font-size: 1em;
            -webkit-appearance: none; /* Eliminar estilos predeterminados del navegador */
            -moz-appearance: none;
            appearance: none;
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px;
            cursor: pointer;
            min-width: 100px; /* Asegura que el select no sea demasiado pequeño */
        }

        .phone-input-group .country-code-select:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
        }

        .phone-input-group input[type="tel"] {
            flex-grow: 1; /* Permite que el input ocupe el espacio restante */
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-background); /* Usar la variable existente */
            color: var(--text-color);
            font-size: 1em;
            box-sizing: border-box; /* Asegura que el padding no aumente el ancho */
        }

        /* Estilos del menú de usuario/invitado */
        .hidden {
            display: none !important;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-menu-container, .guest-menu-container {
            position: relative;
        }
        .user-menu-button, .guest-menu-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #fff;
            padding: 10px;
        }
        .user-menu-dropdown, .guest-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #333;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100;
            border-radius: 5px;
            padding: 10px 0;
        }
        .user-menu-item, .guest-menu-item {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .user-menu-item:hover, .guest-menu-item:hover {
            background-color: #575757;
        }
        .kingcoins-balance {
            color: #FF69B4; /* Color de texto */
            font-weight: 600;
            padding: 10px 15px;
            background-color: #2C2C2E; /* Fondo oscuro */
            border-radius: 20px; /* Borde ovalado */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5); /* Sombra suave */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .kingcoins-balance .fa-crown {
            color: var(--accent-gold); /* Color de la corona, como el morado principal */
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
                justify-content: center;
            }
            .header-right {
                flex-direction: column;
                width: 100%;
                max-width: 350px;
                margin: 0 auto;
                gap: 12px;
            }
            .search-bar, .custom-currency-selector, .user-menu-container, .guest-menu-container {
                width: 100%;
                max-width: none;
            }
            .search-bar input {
                width: 100%;
                padding: 10px 15px 10px 40px;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="index.html" class="logo-link">
                <img src="images/gamingkings_logo.png" alt="GamingKings Logo" class="logo-img">
            </a>
        </div>
        <div class="header-right">
            <div class="kingcoins-balance hidden">
                <i class="fas fa-crown"></i>
                <span id="kingcoins-balance-display">Cargando...</span>
            </div>
            <div class="user-menu-container hidden">
                <button class="user-menu-button" aria-expanded="false" aria-label="Menú de usuario"><i class="fas fa-user-circle"></i></button>
                <div class="user-menu-dropdown hidden">
                    <a href="#" class="user-menu-item" id="user-display-name"></a>
                    <a href="dashboard.html" class="user-menu-item">Dashboard</a>
                    <a href="orders.html" class="user-menu-item">Pedidos</a>
                    <a href="settings.html" class="user-menu-item">Configuración</a>
                    <a href="#" class="user-menu-item" id="logout-button">Cerrar Sesión</a>
                </div>
            </div>
            <div class="guest-menu-container">
                <button class="guest-menu-button" aria-label="Menú de invitado"><i class="fas fa-user-circle"></i></button>
                <div class="guest-menu-dropdown hidden">
                    <a href="login.html" class="guest-menu-item">Iniciar Sesión</a>
                    <a href="signup.html" class="guest-menu-item">Registrarse</a>
                </div>
            </div>
        </div>
    </header>

    <main class="payment-main">
        <div class="form-container">
            <div id="game-payment-header" class="game-payment-header" style="display: none;">
                <img id="gameBannerDisplay" src="" alt="Game Banner">
                <h2 id="gameTitleDisplay">Confirmar Recarga</h2>
            </div>

            <div id="transaction-summary" class="transaction-summary">
                <p>Cargando detalles de la transacción...</p>
            </div>

            <form id="payment-form" style="display: none;">
                <div id="payment-method-step" class="form-section-step">
                    <h3>Paso 1: Selecciona tu Método de Pago</h3>
                    <div class="form-group">
                        <label>Método de Pago:</label>
                        <div class="payment-methods" id="payment-methods">
                        </div>
                    </div>
                </div>

                <div id="payment-details-step" class="form-section-step">
                    <h3>Paso 2: Realiza el Pago y Sube tu Comprobante</h3>
                    <div id="payment-details-form" class="payment-details-form">
                    </div>
                </div>
                
                <div id="kingcoins-payment-container" style="text-align: center; margin-top: 30px; display: none;">
                    <button type="button" class="btn-primary" id="pay-with-kgc-btn">Pagar con mi Wallet (KGC)</button>
                </div>

                <div id="whatsapp-message-container" class="payment-confirmation-message" style="margin-top: 30px; margin-bottom: 20px; text-align: center; display: none;">
                    <p style="font-size: 1.1em; color: var(--text-color); margin-bottom: 15px;">
                        ¡Importante! Una vez realizado el pago con el método seleccionado, <strong>envía la captura de tu comprobante y tus datos de TikTok</strong> al siguiente número de WhatsApp para que tu recarga sea procesada rápidamente:
                    </p>
                    <a href="https://wa.me/573021090841?text=Hola%2C%20acabo%20de%20realizar%20un%20pago%20para%20recarga%20de%20TikTok.%20Mis%20datos%20de%20TikTok%20son%3A%20%5BAQUI_TUS_DATOS%5D."
                        class="whatsapp-link"
                        target="_blank"
                        style="font-size: 1.1em; padding: 12px 25px;">
                        <i class="fab fa-whatsapp"></i> Enviar Captura al WhatsApp
                    </a>
                    <p class="small-text" style="margin-top: 15px;">
                        (Por favor, no olvides incluir tus datos de TikTok en el mensaje de WhatsApp).
                    </p>
                </div>

                <button type="submit" class="btn-primary" id="finalize-recharge-btn" style="display: none;" disabled>Finalizar Recarga</button>
            </form>

            <div id="success-message-display" class="payment-success-message" style="display: none;">
                <h2>🎉 ¡Notificación Enviada! 🎉</h2>
                <p>Hemos recibido tu solicitud de recarga. Te enviaremos un correo de confirmación y la factura virtual una vez que tu recarga sea procesada.</p>
                <p>¡Gracias por usar GamingKings!</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 GamingKings. Todos los derechos reservados.</p>
            <div class="footer-links">
                <a href="privacy.html">Políticas de Privacidad</a>
                <a href="terms.html">Términos de Servicio</a>
            </div>
            <a href="https://wa.me/573021090841" target="_blank" class="whatsapp-link">
                <i class="fab fa-whatsapp"></i> Contáctanos por WhatsApp
            </a>
        </div>
    </footer>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="module">
    // 1. EL IMPORT DEBE SER LO PRIMERO EN UN MÓDULO.
    import { supabase } from './supabaseClient.js';

    // 2. DECLARACIÓN DE VARIABLES
    const userMenuContainer = document.querySelector('.user-menu-container');
    const guestMenuContainer = document.querySelector('.guest-menu-container');
    const userDisplayName = document.getElementById('user-display-name');
    const kingcoinsBalanceDisplay = document.getElementById('kingcoins-balance-display');
    const kingcoinsBalanceHeader = document.querySelector('.kingcoins-balance');
    const logoutButton = document.getElementById('logout-button');
    const userMenuButton = document.querySelector('.user-menu-button');
    const userMenuDropdown = document.querySelector('.user-menu-dropdown');
    const guestMenuButton = document.querySelector('.guest-menu-button');
    const guestMenuDropdown = document.querySelector('.guest-menu-dropdown');

    let userProfileData = null;
    let transactionDetails = null;
    let userSession = null;

    const paymentDetailsTemplates = {
        'pago-movil': `
            <p><strong>Paso 1:</strong> Realiza el Pago Móvil a los siguientes datos:</p>
            <ul>
                <li><strong>Banco:</strong> Banco de Venezuela (0102)</li>
                <li><strong>Cédula/RIF:</strong> V-31605458</li>
                <li><strong>Teléfono:</strong> 0412-7123391</li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `,
        'binance': `
            <p><strong>Paso 1:</strong> Realiza la transferencia a nuestra cuenta Binance (USDT BEP20) O (Binance Pay).</p>
            <ul>
                <p><strong>USDT (BEP20):</strong></p>
                <li>
                    <div class="copy-container">
                        <span class="address-label">Dirección de Billetera BEP20:</span>
                        <span class="wallet-address" id="binance-address">0x9ebe5fe682123c531408944236a99754886a46dd</span>
                        <button type="button" class="copy-button" data-copy-target="binance-address">Copiar</button>
                        <span class="copy-feedback" id="binance-copy-feedback">¡Copiado!</span>
                    </div>
                </li>
                <li><strong>Moneda:</strong> USDT (BEP20)</li>
                <p><strong>Binance Pay:</strong></p>
                <li><strong>ID Binance Pay:</strong> 909792776</li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `,
        'zinli': `
            <p><strong>Paso 1:</strong> Transfiere el monto exacto a nuestra cuenta Zinli.</p>
            <ul>
                <li><strong>Usuario Zinli:</strong> endryreyes199@gmail.com</li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `
    };

    const paymentMethodsVES = [
        { id: 'pago-movil', name: 'Pago Móvil', type: 'ves', icon: 'fas fa-mobile-alt' }
    ];

    const paymentMethodsUSD = [
        { id: 'binance', name: 'Binance', type: 'usd', icon: 'fab fa-bitcoin' },
        { id: 'zinli', name: 'Zinli', type: 'usd', icon: 'fas fa-wallet' }
    ];

    // Nuevo array para el método KingCoins (separado para la lógica)
    const paymentMethodsKGC = [
        { id: 'kingcoins', name: 'Mi Wallet KingCoins', type: 'kgc', icon: 'fas fa-crown' }
    ];

    const paymentForm = document.getElementById('payment-form');
    const paymentMethodStep = document.getElementById('payment-method-step');
    const paymentDetailsStep = document.getElementById('payment-details-step');
    const kingcoinsPaymentContainer = document.getElementById('kingcoins-payment-container');
    const payWithKGCBtn = document.getElementById('pay-with-kgc-btn');
    const whatsappMessageContainer = document.getElementById('whatsapp-message-container');
    const finalizeBtn = document.getElementById('finalize-recharge-btn');
    const successMessageDisplay = document.getElementById('success-message-display');
    const gamePaymentHeader = document.getElementById('game-payment-header');
    const gameBannerDisplay = document.getElementById('gameBannerDisplay');
    const gameTitleDisplay = document.getElementById('gameTitleDisplay');
    const transactionSummaryDiv = document.getElementById('transaction-summary');

    // 3. FUNCIONES
    function toggleDropdown(dropdown) {
        dropdown.classList.toggle('hidden');
    }

    function setupEventListeners() {
        userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(userMenuDropdown);
            if (!guestMenuDropdown.classList.contains('hidden')) {
                toggleDropdown(guestMenuDropdown);
            }
        });

        guestMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(guestMenuDropdown);
            if (!userMenuDropdown.classList.contains('hidden')) {
                toggleDropdown(userMenuDropdown);
            }
        });

        document.addEventListener('click', () => {
            if (!userMenuDropdown.classList.contains('hidden')) {
                toggleDropdown(userMenuDropdown);
            }
            if (!guestMenuDropdown.classList.contains('hidden')) {
                toggleDropdown(guestMenuDropdown);
            }
        });

        if (logoutButton) {
            logoutButton.addEventListener('click', handleLogout);
        }

        if (payWithKGCBtn) { // Asegúrate de que el evento esté aquí
            payWithKGCBtn.addEventListener('click', handleKGCPayment);
        }
    }

    async function fetchUserProfile(userId) {
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('name, last_name')
            .eq('id', userId)
            .single();

        const { data: wallet, error: walletError } = await supabase
            .from('user_wallets')
            .select('balance')
            .eq('user_id', userId)
            .single();

        if (profileError && profileError.code !== 'PGRST116') { // Ignorar 'no rows found' para profile
            console.error('Error fetching user profile:', profileError.message);
        }
        if (walletError && walletError.code !== 'PGRST116') { // Ignorar 'no rows found' para wallet
            console.error('Error fetching user wallet:', walletError.message);
        }
        
        return {
            name: profile?.name || 'Usuario',
            last_name: profile?.last_name || '',
            kingcoins_balance: wallet?.balance || 0
        };
    }

    async function checkUserSession() {
        const { data: { session } } = await supabase.auth.getSession();
        userSession = session;
        if (userSession) {
            userMenuContainer.classList.remove('hidden');
            guestMenuContainer.classList.add('hidden');
            
            userProfileData = await fetchUserProfile(userSession.user.id);
            if (userProfileData) {
                userDisplayName.textContent = `${userProfileData.name} ${userProfileData.last_name || ''}`;
                if (userProfileData.kingcoins_balance !== undefined) {
                    kingcoinsBalanceDisplay.textContent = `${userProfileData.kingcoins_balance.toFixed(2)}`;
                    kingcoinsBalanceHeader.classList.remove('hidden');
                }
            } else {
                userDisplayName.textContent = userSession.user.email || 'Usuario';
            }
        } else {
            userMenuContainer.classList.add('hidden');
            guestMenuContainer.classList.remove('hidden');
            kingcoinsBalanceHeader.classList.add('hidden');
        }
        return userProfileData;
    }

    async function handleLogout() {
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error('Error al cerrar sesión:', error.message);
        } else {
            window.location.href = 'index.html';
        }
    }
    
    function updateGameHeader() {
        if (transactionDetails && transactionDetails.game) {
            gamePaymentHeader.style.display = 'block';
            gameTitleDisplay.textContent = `Confirmar Recarga para ${transactionDetails.game}`;
            if (transactionDetails.gameBanner) {
                gameBannerDisplay.src = transactionDetails.gameBanner;
                gameBannerDisplay.style.display = 'block';
            } else {
                gameBannerDisplay.style.display = 'none';
            }
        } else {
            gamePaymentHeader.style.display = 'none';
        }
    }

    function updateTransactionSummary() {
        if (!transactionDetails) {
            transactionSummaryDiv.innerHTML = '<p>No se encontraron detalles de la transacción.</p>';
            return;
        }
        
        const displayAmount = parseFloat(transactionDetails.finalPrice);
        const displayCurrency = transactionDetails.currency;
        
        let otherCurrencyDisplay = '';
        if (transactionDetails.priceUSD && transactionDetails.priceVES) {
            if (displayCurrency === 'VES') {
                otherCurrencyDisplay = ` (~ $${parseFloat(transactionDetails.priceUSD).toFixed(2)} USD)`;
            } else if (displayCurrency === 'USD') {
                otherCurrencyDisplay = ` (~ Bs. ${parseFloat(transactionDetails.priceVES).toFixed(2)} VES)`;
            }
        }

        const playerIdHtml = transactionDetails.playerId ? `<p><strong>ID de Jugador:</strong> ${transactionDetails.playerId}</p>` : '';
        
        // Lógica para cambiar el mensaje de saludo
        let greeting = '';
        if (displayCurrency === 'KGC') {
            greeting = 'Por favor, realiza tu pago con KingCoins a continuación.';
        } else {
            greeting = 'Por favor, selecciona tu método a continuación y realiza el pago por el monto exacto.';
        }

        if (userProfileData && userProfileData.name) {
            if (displayCurrency === 'KGC') {
                greeting = `Hola ${userProfileData.name} ${userProfileData.last_name || ''}, por favor, realiza tu pago con KingCoins a continuación.`;
            } else {
                greeting = `Hola ${userProfileData.name} ${userProfileData.last_name || ''}, por favor, selecciona tu método a continuación y realiza el pago por el monto exacto.`;
            }
        }

        transactionSummaryDiv.innerHTML = `
            <p><strong>Juego:</strong> ${transactionDetails.game}</p>
            ${playerIdHtml}
            <p><strong>Plan Seleccionado:</strong> ${transactionDetails.package}</p>
            <p><strong>Total a Pagar:</strong> <span class="amount">${displayCurrency === 'VES' ? 'Bs.' : (displayCurrency === 'USD' ? '$' : '')} ${displayAmount.toFixed(2)} ${displayCurrency}</span>${otherCurrencyDisplay}</p>
            <p>${greeting}</p>
        `;
    }

    // --- FUNCIÓN DE MÉTODOS DE PAGO CORREGIDA ---
    function updatePaymentMethods() {
        const paymentMethodsDiv = document.getElementById('payment-methods');
        paymentMethodsDiv.innerHTML = '';
        if (!transactionDetails) return;
        const currentCurrency = transactionDetails.currency;
        
        paymentMethodStep.style.display = 'none';
        paymentDetailsStep.style.display = 'none';
        kingcoinsPaymentContainer.style.display = 'none';
        finalizeBtn.style.display = 'none';

        // Lógica: Si el pago es en KGC, o si el juego es KingsCoins, muestra el paso de KGC.
        const isBuyingKingCoins = transactionDetails.game === "KingsCoins"; // Nueva variable para distinguir la compra de la moneda
        
        // Si la moneda de pago seleccionada es KGC (cuando el cliente usa KingCoins para pagar un producto)
        if (currentCurrency === 'KGC') {
            if (userSession) {
                kingcoinsPaymentContainer.style.display = 'block';
                // Si el botón ya tiene el listener, no necesitamos añadirlo de nuevo aquí, solo asegurarnos que se vea.
            } else {
                kingcoinsPaymentContainer.innerHTML = '<p>Debes <a href="login.html">iniciar sesión</a> para pagar con KingCoins.</p>';
                kingcoinsPaymentContainer.style.display = 'block';
            }
            return;
        }
        
        // Si el juego es KingsCoins, forzamos la no-visualización de métodos KGC
        if (isBuyingKingCoins) {
            // El cliente está comprando KingCoins con dinero real, por lo que NUNCA debe ver la opción de pagar con KingCoins.
            // Continuamos con el flujo normal de pago (VES/USD)
        } else {
            // Si el juego NO es KingsCoins, y la moneda actual NO es KGC, mostramos el paso de selección de pago (VES/USD)
            // Y luego permitimos la opción de pago con KGC como método de pago.

            // Nota: Con tu lógica actual, si el cliente seleccionó USD/VES, el botón de KGC aparece al final.
            // Para mantener la consistencia de tu UI (USD/VES en la primera caja, KGC en la segunda):
            // Si el juego NO es KingCoins, podemos mantener el flujo actual de radio buttons (VES/USD) y el botón de Pagar con KGC al final.
            // PERO la forma más limpia es hacer que la opción de KingCoins aparezca como un botón de pago MÁS.

            // Aquí vamos a forzar la lógica de pago normal (USD/VES) si no es KGC.
            paymentMethodStep.style.display = 'block';
            paymentDetailsStep.style.display = 'block';
            finalizeBtn.style.display = 'block';
        }
        
        let methods = [];
        if (currentCurrency === 'VES') {
            methods = paymentMethodsVES;
        } else if (currentCurrency === 'USD') {
            methods = paymentMethodsUSD;
        }

        // Si NO está comprando KingCoins, añade la opción KingCoins como radio button (método de pago alternativo)
        // Ya que la lógica de tu HTML lo maneja con un botón aparte (<div id="kingcoins-payment-container">),
        // solo nos enfocaremos en los radio buttons (VES/USD).
        
        methods.forEach(method => {
            const methodItem = document.createElement('div');
            methodItem.classList.add('payment-method-option');
            methodItem.innerHTML = `
                <input type="radio" id="method-${method.id}" name="paymentMethod" value="${method.id}" data-type="${method.type}">
                <label for="method-${method.id}">
                    <i class="${method.icon}"></i>
                    <span>${method.name}</span>
                </label>
            `;
            paymentMethodsDiv.appendChild(methodItem);
        });

        paymentMethodsDiv.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const selectedMethodId = event.target.value;
                loadPaymentDetails(selectedMethodId);
                checkFormValidity();
            });
        });
        
        // MOSTRAR CONTENEDOR DE PAGO CON KGC si NO está comprando KingCoins y hay sesión
        if (!isBuyingKingCoins && userSession) {
            kingcoinsPaymentContainer.style.display = 'block';
        } else {
            kingcoinsPaymentContainer.style.display = 'none';
        }
        
        checkFormValidity();
    }
    // --- FIN FUNCIÓN DE MÉTODOS DE PAGO CORREGIDA ---

    function loadPaymentDetails(methodId) {
        const paymentDetailsFormDiv = document.getElementById('payment-details-form');
        let methodHtml = paymentDetailsTemplates[methodId];

        if (methodHtml) {
            paymentDetailsFormDiv.innerHTML = methodHtml;

            if (transactionDetails.game === "TikTok") {
                const fieldsContainer = paymentDetailsFormDiv.querySelector('.payment-fields-container');
                if (fieldsContainer) {
                    fieldsContainer.style.display = 'none';
                }
            } else {
                const fileInput = document.getElementById('payment-receipt');
                if (fileInput) {
                    fileInput.addEventListener('change', checkFormValidity);
                    fileInput.required = true; 
                }
            }

            const copyButton = paymentDetailsFormDiv.querySelector('.copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', handleCopyButtonClick);
            }

        } else {
            paymentDetailsFormDiv.innerHTML = '<p>Selecciona un método de pago para ver los detalles.</p>';
        }
        checkFormValidity();
    }

    async function handleCopyButtonClick(event) {
        const button = event.currentTarget;
        const targetId = button.dataset.copyTarget;
        const textToCopyElement = document.getElementById(targetId);
        const feedbackElement = document.getElementById(`${targetId}-copy-feedback`);

        if (textToCopyElement && navigator.clipboard) {
            try {
                await navigator.clipboard.writeText(textToCopyElement.textContent);
                if (feedbackElement) {
                    feedbackElement.textContent = '¡Copiado!';
                    feedbackElement.style.display = 'inline-block';
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 1500);
                }
            } catch (err) {
                console.error('Error al copiar: ', err);
                if (feedbackElement) {
                    feedbackElement.textContent = 'Error al copiar';
                    feedbackElement.style.display = 'inline-block';
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 1500);
                }
                alert('No se pudo copiar el texto. Por favor, cópialo manualmente.');
            }
        } else {
            alert('Tu navegador no soporta la copia automática o no se encontró el elemento. Por favor, selecciona y copia la dirección manualmente.');
        }
    }

    function checkFormValidity() {
        const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
        const isMethodSelected = selectedRadio !== null;
        
        let areDetailsFilled = false;
        if (isMethodSelected) {
            if (transactionDetails.game === "TikTok") {
                areDetailsFilled = true;
            } else {
                const fileInput = document.getElementById('payment-receipt');
                areDetailsFilled = fileInput && fileInput.files.length > 0;
            }
        }
        
        finalizeBtn.disabled = !areDetailsFilled;
        // Solo muestra el botón si está habilitado y si NO es un pago con KGC
        if (!isMethodSelected || transactionDetails.currency === 'KGC') {
            finalizeBtn.style.display = 'none';
        } else {
            finalizeBtn.style.display = areDetailsFilled ? 'block' : 'none';
        }
    }

    async function handleKGCPayment() {
        if (!userSession) {
            alert('Debes iniciar sesión para usar KingCoins.');
            window.location.href = 'login.html';
            return;
        }

        // Recarga el perfil para obtener el saldo más reciente
        await checkUserSession(); 
        
        if (!userProfileData || userProfileData.kingcoins_balance === undefined) {
            alert('No se pudo obtener el saldo de tu billetera. Por favor, intenta recargar la página.');
            return;
        }

        const amountNeeded = parseFloat(transactionDetails.finalPrice);
        if (userProfileData.kingcoins_balance < amountNeeded) {
            alert('Saldo insuficiente de KingCoins. Por favor, recarga tu billetera o selecciona otro método de pago.');
            return;
        }

        await submitKingcoinsRequest();
    }
    
    async function submitKingcoinsRequest() {
        const buttonToDisable = payWithKGCBtn;
        const originalButtonText = buttonToDisable.textContent;
        buttonToDisable.disabled = true;
        buttonToDisable.textContent = 'Procesando...';

        const formData = new FormData();
        for (const key in transactionDetails) {
            if (key !== 'userEmail' && key !== 'email') { 
                formData.append(key, transactionDetails[key]);
            }
        }
        formData.append('email', userSession.user.email);
        formData.append('paymentMethod', 'kingcoins'); // Usamos 'kingcoins' en minúsculas para la consistencia con el backend

        try {
            // Paso 1: Deducción de KingCoins
            const deductResponse = await fetch('/.netlify/functions/deduct-kingcoins', {
                method: 'POST',
                body: formData
            });

            if (!deductResponse.ok) {
                const errorData = await deductResponse.json();
                throw new Error(errorData.message || 'Error desconocido al deducir KingCoins.');
            }

            // Paso 2: Notificación a Telegram a través de process-payment.js
            const processPaymentResponse = await fetch('/.netlify/functions/process-payment', {
                method: 'POST',
                body: formData
            });

            if (processPaymentResponse.ok) {
                alert('¡Pago con KingCoins realizado con éxito! La recarga ha sido acreditada y el equipo de soporte ha sido notificado.');
                localStorage.removeItem('transactionDetails');
                window.location.href = 'index.html'; 
            } else {
                const errorData = await processPaymentResponse.json();
                console.error('Error al notificar el pago a través de process-payment:', errorData);
                // NOTA: No hacemos rollback, solo advertimos al cliente.
                alert(`¡El pago se procesó, pero hubo un error al notificarlo! El saldo se ha deducido. Por favor, toma una captura de pantalla de este mensaje y contacta a soporte para verificar tu recarga. Error: ${errorData.message}`);
            }

        } catch (error) {
            alert('Hubo un problema: ' + error.message);
            console.error('Error durante el proceso de pago con KingCoins:', error);
        } finally {
            buttonToDisable.disabled = false;
            buttonToDisable.textContent = originalButtonText;
        }
    }

    async function submitPaymentRequest(paymentMethod) {
        if (!userSession) {
            alert('Debes iniciar sesión para finalizar el pago.');
            window.location.href = 'login.html';
            return;
        }
        
        let formData = new FormData();
        formData.append('paymentMethod', paymentMethod);
        formData.append('email', userSession.user.email);
        formData.append('userEmail', userSession.user.email);

        if (transactionDetails.game !== "TikTok") {
            const paymentReceipt = document.getElementById('payment-receipt');
            if (!paymentReceipt || paymentReceipt.files.length === 0) {
                alert('Por favor, sube tu comprobante de pago para continuar.');
                return;
            }
            formData.append('paymentReceipt', paymentReceipt.files[0]);
        }
        
        for (const key in transactionDetails) {
            formData.append(key, transactionDetails[key]);
        }

        const buttonToDisable = finalizeBtn;
        const originalButtonText = buttonToDisable.textContent;
        buttonToDisable.disabled = true;
        buttonToDisable.textContent = 'Procesando...';

        try {
            const response = await fetch('/.netlify/functions/process-payment', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                paymentForm.style.display = 'none';
                whatsappMessageContainer.style.display = 'none';
                successMessageDisplay.style.display = 'block';
                gamePaymentHeader.style.display = 'none';

                localStorage.removeItem('transactionDetails');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            } else {
                const errorData = await response.json();
                alert(`Ocurrió un error: ${errorData.message || response.statusText}. Por favor, verifica tus datos e inténtalo de nuevo.`);
                console.error('Server error:', errorData);
                buttonToDisable.disabled = false;
                buttonToDisable.textContent = originalButtonText;
            }
        } catch (error) {
            alert('Hubo un problema de conexión. Por favor, inténtalo de nuevo más tarde.');
            console.error('Network or client error:', error);
            buttonToDisable.disabled = false;
            buttonToDisable.textContent = originalButtonText;
        }
    }
    
    function handleFormSubmission() {
        if (payWithKGCBtn) {
            payWithKGCBtn.addEventListener('click', handleKGCPayment);
        }
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (selectedMethod) {
                submitPaymentRequest(selectedMethod.value);
            }
        });
    }
    
    // 4. LÓGICA PRINCIPAL - Reordenada
    document.addEventListener('DOMContentLoaded', async () => {
        // Validación de sesión inicial (Mantenida por si acaso)
        const { data: { session: initialSession } } = await supabase.auth.getSession();
        if (!initialSession) {
            window.location.href = 'index.html'; 
            return;
        }

        setupEventListeners();
        
        const storedDetails = localStorage.getItem('transactionDetails');
        if (storedDetails) {
            try {
                transactionDetails = JSON.parse(storedDetails);
                if (transactionDetails && transactionDetails.game && transactionDetails.package && transactionDetails.finalPrice) {
                    await checkUserSession();
                    
                    updateGameHeader();
                    // ESTA ES LA FUNCIÓN CLAVE CORREGIDA
                    updatePaymentMethods(); 
                    updateTransactionSummary();

                    paymentForm.style.display = 'block';

                    if (transactionDetails.game === "TikTok") {
                        whatsappMessageContainer.style.display = 'block';
                    } else {
                        whatsappMessageContainer.style.display = 'none';
                    }
                    
                    handleFormSubmission();
                } else {
                    throw new Error('Transaction details are incomplete or invalid.');
                }
            } catch (e) {
                console.error("Error parsing transaction details from localStorage:", e);
                transactionSummaryDiv.innerHTML = '<p>Error al cargar los detalles de la transacción. Por favor, regresa a la página de inicio y selecciona un plan para la recarga.</p>';
                paymentForm.style.display = 'none';
                whatsappMessageContainer.style.display = 'none';
                gamePaymentHeader.style.display = 'none';
            }
        } else {
            transactionSummaryDiv.innerHTML = '<p>No se encontraron detalles de la transacción. Por favor, regresa a la página de inicio y selecciona un plan para la recarga.</p>';
            paymentForm.style.display = 'none';
            whatsappMessageContainer.style.display = 'none';
            gamePaymentHeader.style.display = 'none';
        }
    });
</script>
</body>
</html>