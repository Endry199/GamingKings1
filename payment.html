<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Pago - GamingKings</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <style>
/* Estilos para el bot√≥n de copiar y el mensaje */
        .copy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .copy-container .wallet-address {
            display: none; /* Oculta la direcci√≥n real */
        }
        .copy-button {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .copy-button:hover {
            background-color: #0056b3;
        }
        .copy-feedback {
            display: none;
            margin-left: 10px;
            color: #28a745;
            font-size: 0.9em;
            font-weight: bold;
        }
        /* Estilo para la etiqueta de la direcci√≥n */
        .address-label {
            font-weight: bold;
            color: var(--text-color);
        }
        /* Estilo para los nuevos campos de correo y whatsapp */
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        .input-group input[type="email"],
        .input-group input[type="tel"],
        .input-group input[type="text"], /* A√±adido para Binance ID */
        .input-group input[type="password"] { /* A√±adido para Wallet */
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-background);
            color: var(--text-color);
            box-sizing: border-box; /* Asegura que el padding no aumente el ancho */
        }
        /* Estilo para el mensaje de √©xito */
        .payment-success-message {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--accent-green-light); /* Un color de fondo suave para el √©xito */
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            text-align: center;
            color: var(--accent-green); /* Color del texto */
        }
        .payment-success-message h2 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .payment-success-message p {
            margin-bottom: 0;
        }
        /* Estilos para los pasos */
        .form-section-step {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .form-section-step h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        /* Nuevo estilo para el contenedor de la contrase√±a */
        .password-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-password {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
        }

        /* üöÄ FIX DE VISUALIZACI√ìN DE BOTONES DE PAGO üöÄ */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* M√≠nimo 140px de ancho */
            gap: 15px;
            margin-top: 10px;
        }

        .payment-method-option input[type="radio"] {
            display: none; /* Oculta el radio button nativo */
        }

        .payment-method-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border: 2px solid var(--border-color, #ccc);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            height: 100%; /* Para que todos tengan la misma altura */
            background-color: var(--input-background); /* Asegurar color de fondo */
        }

        .payment-method-option label:hover {
            border-color: var(--primary-color, #007bff);
        }

        .payment-method-option input[type="radio"]:checked + label {
            border-color: var(--accent-green, #28a745);
            background-color: var(--accent-green-light, #e9f7ef);
            color: var(--text-color, #333);
        }

        .payment-method-option label i {
            font-size: 2em;
            margin-bottom: 8px;
            color: var(--primary-color, #007bff);
        }

        .payment-method-option input[type="radio"]:checked + label i {
            color: var(--accent-green, #28a745);
        }
        /* ------------------------------------------- */
        
        /* ‚è∞ NUEVOS ESTILOS PARA EL TEMPORIZADOR ‚è∞ */
        #payment-timer-container {
            position: fixed;
            top: 100px; /* Ajusta la posici√≥n vertical */
            right: 20px;
            background-color: #ff1493; /* Color llamativo de advertencia */
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 1.1em;
            font-weight: bold;
            z-index: 1000; /* Asegura que est√© por encima de otros elementos */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #payment-timer-container.expired {
            background-color: #dc3545; /* Rojo para cuando expire */
            color: white;
        }

        @media (max-width: 768px) {
            #payment-timer-container {
                top: auto;
                bottom: 20px;
                right: 50%;
                transform: translateX(50%);
                width: 90%;
                justify-content: center;
                text-align: center;
            }
        }
        /* --------------------------------------- */
    </style>
</head>
<body>
    <div id="payment-timer-container" style="display: none;">
        <i class="fas fa-clock"></i>
        <span>Tiempo restante para completar el pago: </span>
        <span id="payment-timer">15:00</span>
    </div>
    <header>
    <div class="header-left">
        <a href="index.html" class="logo-link">
            <img src="images/gamingkings_logo.png" alt="GamingKings Logo" class="logo-img">
        </a>
    </div>
    <div class="header-right">
        
        <div class="wallet-container" id="wallet-container" style="display:none;"> 
            <div class="wallet-display">
                <i class="fas fa-wallet"></i>
                <span id="virtual-balance">$. --.--</span>
            </div>
            <a href="rechargedwallet.html" class="recharge-btn" title="Recargar Saldo">
                <i class="fas fa-plus"></i>
            </a>
        </div>
        <div class="auth-dropdown" id="auth-dropdown">
            <button class="auth-btn" id="toggle-login-btn">
                <i class="fas fa-user-circle"></i>
                <img src="images/default_user.png" alt="Usuario" class="auth-user-picture" id="auth-user-picture" style="display:none;">
            </button>
            
            <div class="dropdown-content">
                <a href="#" class="auth-display-name" id="auth-display-name">Iniciar Sesi√≥n</a>
                <hr>
                
                <div id="google-login-btn" style="display: block;">
                    </div>
                
                <button id="logout-btn" class="logout-btn" style="display:none;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </div>
</header>

    <main class="payment-main">
        <div class="form-container">
            <h2>Confirmar Recarga y Seleccionar M√©todo de Pago</h2>
            <div id="transaction-summary" class="transaction-summary">
            </div>

            <form id="payment-form">
                <div class="form-section-step">
                    <h3>Paso 1: Selecciona tu M√©todo de Pago</h3>
                    <div class="form-group">
                        <label>M√©todo de Pago:</label>
                        <div class="payment-methods" id="payment-methods">
                        </div>
                    </div>
                </div>

                <div class="form-section-step">
                    <h3>Paso 2: Realiza el Pago y Sube tu Comprobante</h3>
                    <div id="payment-details-form" class="payment-details-form">
                    </div>
                </div>
                
                <div class="form-section-step">
                    <h3>Paso 3: Informaci√≥n de Contacto para Notificaciones</h3>
                    
                    <div class="input-group">
                        <label for="whatsappNumber">N√∫mero de WhatsApp (Para contacto):</label>
                        <input type="tel" id="whatsappNumber" name="whatsappNumber" placeholder="Ej: 584121234567" required>
                    </div>
                </div>
                <div id="whatsapp-message-container" class="payment-confirmation-message" style="margin-top: 30px; margin-bottom: 20px; text-align: center; display: none;">
                    <p style="font-size: 1.1em; color: var(--text-color); margin-bottom: 15px;">
                        ¬°Importante! Una vez realizado el pago con el m√©todo seleccionado, <strong>env√≠a la captura de tu comprobante y tus datos de TikTok</strong> al siguiente n√∫mero de WhatsApp para que tu recarga sea procesada r√°pidamente:
                    </p>
                    <a href="https://wa.me/584126949631?text=Hola%2C%20acabo%20de%20realizar%20un%20pago%20para%20recarga%20de%20TikTok.%20Mis%20datos%20de%20TikTok%20son%3A%20%5BAQUI_TUS_DATOS%5D."
                        class="whatsapp-link"
                        target="_blank"
                        style="font-size: 1.1em; padding: 12px 25px;">
                        <i class="fab fa-whatsapp"></i> Enviar Captura al WhatsApp
                    </a>
                    <p class="small-text" style="margin-top: 15px;">
                        (Por favor, no olvides incluir tus datos de TikTok en el mensaje de WhatsApp).
                    </p>
                </div>

                <button type="submit" class="btn-primary" id="finalize-recharge-btn" disabled>Finalizar Recarga</button>
            </form>

            <div id="success-message-display" class="payment-success-message" style="display: none;">
                <h2>üéâ ¬°Notificaci√≥n Enviada! üéâ</h2>
                <p>Hemos recibido tu solicitud de recarga. Te enviaremos un correo de confirmaci√≥n y la factura virtual una vez que tu recarga sea procesada.</p>
                <p>¬°Gracias por usar Centro de Recargas GamingKings!</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 GamingKings. Todos los derechos reservados.</p>
            <div class="footer-links">
                <a href="privacy.html">Pol√≠ticas de Privacidad</a>
                <a href="terms.html">T√©rminos de Servicio</a>
            </div>
            <a href="https://wa.me/573021090841" target="_blank" class="whatsapp-link">
                <i class="fab fa-whatsapp"></i> Cont√°ctanos por WhatsApp
            </a>
        </div>
    </footer>

<script src="script.js"></script>
<script>
// 1. PLANTILLAS Y DATOS ESTATICOS
    const paymentDetailsTemplates = {
        'pago-movil': `
            <p><strong>Paso 1:</strong> Realiza el Pago M√≥vil a los siguientes datos:</p>
            <ul>
                <li><strong>Banco:</strong> Banco de Mercantil (0102)</li>
                <li class="copy-container">
                    <strong>C√©dula/RIF:</strong> <span id="pm-cedula">V-31605458</span>
                    <button type="button" class="copy-button" data-copy-target="pm-cedula"><i class="fas fa-copy"></i></button>
                    <span id="pm-cedula-copy-feedback" class="copy-feedback"></span>
                </li>
                <li class="copy-container">
                    <strong>Tel√©fono:</strong> <span id="pm-telefono">0412-7123391</span>
                    <button type="button" class="copy-button" data-copy-target="pm-telefono"><i class="fas fa-copy"></i></button>
                    <span id="pm-telefono-copy-feedback" class="copy-feedback"></span>
                </li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `,
        // Plantilla para Plisio (Redirecci√≥n de pago)
        'binance': `
            <div class="payment-fields-container">
                <p><strong>Paso 1:</strong> Ser√°s redirigido a la pasarela segura de Plisio para completar tu pago con criptomonedas.</p>
                <p><strong>Paso 2:</strong> Al finalizar el pago en la pasarela, ser√°s autom√°ticamente redirigido de vuelta. La confirmaci√≥n del pago es autom√°tica.</p>
                <input type="hidden" id="payment-receipt" name="paymentReceipt" value="Plisio_Managed_Payment" required> 
            </div>
        `,
        // Plantilla para Zinli (Comprobante requerido)
        'zinli': `
            <p><strong>Paso 1:</strong> Transfiere el monto exacto a nuestra cuenta Zinli.</p>
            <ul>
                <li class="copy-container">
                    <strong>Usuario Zinli:</strong> <span id="zinli-email">endryreyes199@gmail.com</span>
                    <button type="button" class="copy-button" data-copy-target="zinli-email"><i class="fas fa-copy"></i></button>
                    <span id="zinli-email-copy-feedback" class="copy-feedback"></span>
                </li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `,
        // üÜï NUEVA PLANTILLA: Binance Pay (Transferencia por ID)
        'binance-id': `
            <p><strong>Paso 1:</strong> Transfiere el monto exacto por Binance Pay a la siguiente ID:</p>
            <ul>
                <li class="copy-container">
                    <strong>Binance Pay ID (MUID):</strong> <span id="binance-muid">909792776swe</span>
                    <button type="button" class="copy-button" data-copy-target="binance-muid"><i class="fas fa-copy"></i></button>
                    <span id="binance-muid-copy-feedback" class="copy-feedback"></span>
                </li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube el comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf">
                </div>
        `,
        // üéØ Plantilla para Wallet
        'wallet': `
            <div class="payment-fields-container">
                <p><strong>Paso 1:</strong> Confirma la deducci√≥n de <span id="wallet-final-price" style="font-weight: bold;"></span> de tu Wallet de la p√°gina.</p>
                <p style="font-size: 0.9em; color: #ff9800;">(Aseg√∫rate de tener saldo suficiente antes de continuar. La deducci√≥n se har√° al presionar "Finalizar Recarga")</p>
                <input type="hidden" id="payment-receipt" name="paymentReceipt" value="Wallet_Deduction_Flow" required>
                </div>
        `
    };

    const paymentMethodsVES = [
        { id: 'pago-movil', name: 'Pago M√≥vil', type: 'ves', icon: 'fas fa-mobile-alt' }
    ];

    const paymentMethodsUSD = [
        { id: 'binance', name: 'Binance (Pasarela)', type: 'usd', icon: 'fab fa-bitcoin' },
        { id: 'binance-id', name: 'Binance Pay (ID)', type: 'usd', icon: 'fas fa-money-check-alt' },
        { id: 'zinli', name: 'Zinli', type: 'usd', icon: 'fas fa-coins' },
    ];

    // üéØ CAMBIO CLAVE: Nueva lista para la moneda USDM (Solo Wallet)
    const paymentMethodsUSDM = [
        { id: 'wallet', name: 'Wallet (Saldo en P√°gina)', type: 'usdm', icon: 'fas fa-wallet' }
    ];

    // 2. VARIABLES GLOBALES DE LA PAGINA
    let transactionDetails = null;
    const paymentForm = document.getElementById('payment-form');
    const whatsappMessageContainer = document.getElementById('whatsapp-message-container');
    const finalizeBtn = document.getElementById('finalize-recharge-btn');
    const successMessageDisplay = document.getElementById('success-message-display');
    const paymentDetailsFormDiv = document.getElementById('payment-details-form');
    const paymentMethodsDiv = document.getElementById('payment-methods'); 
    
    // ‚è∞ NUEVAS VARIABLES GLOBALES PARA EL TEMPORIZADOR ‚è∞
    const PAYMENT_TIMEOUT_MINUTES = 15;
    const paymentTimerContainer = document.getElementById('payment-timer-container');
    const paymentTimerDisplay = document.getElementById('payment-timer');
    let timerInterval;

    // üîê NUEVAS VARIABLES DE SEGURIDAD Y REDIRECCI√ìN
    const SESSION_TOKEN_KEY = 'userSessionToken'; // Clave usada en el flujo de Wallet
    const LOGIN_PAGE_URL = 'login.html'; // P√°gina a la que redirigir


    // 3. FUNCIONES DE L√ìGICA
    
    /**
     * üîê NUEVA FUNCI√ìN CLAVE: Verifica si existe un token de sesi√≥n activo.
     * Si no lo hay, redirige a login.html, guardando la URL actual para volver.
     * @returns {boolean} True si la sesi√≥n es v√°lida, False si redirige.
     */
    function checkActiveSession() {
        // üö® Usamos la clave correcta para el token de sesi√≥n (ver flujo de Wallet)
        const sessionToken = localStorage.getItem(SESSION_TOKEN_KEY); 

        // Si la sesi√≥n no existe, redirigimos
        if (!sessionToken) {
            // Guardar la URL actual de payment.html en localStorage para volver despu√©s del login
            localStorage.setItem('redirectAfterLogin', window.location.href);

            // Redirigir al usuario a la p√°gina de login
            alert('Debes iniciar sesi√≥n para acceder a la p√°gina de pago. Ser√°s redirigido a la p√°gina de inicio de sesi√≥n.');
            window.location.href = LOGIN_PAGE_URL;
            return false;
        }
        return true;
    }

    /**
     * ‚è∞ NUEVA FUNCI√ìN CLAVE: Inicia o restaura el temporizador de pago.
     */
    function startPaymentTimer() {
        const startTime = localStorage.getItem('paymentStartTime');
        const now = new Date().getTime();
        const duration = PAYMENT_TIMEOUT_MINUTES * 60 * 1000;
        let endTime;

        if (startTime) {
            endTime = parseInt(startTime) + duration;
        } else {
            // Si no hay hora de inicio, es la primera vez que se carga la p√°gina de pago.
            endTime = now + duration;
            localStorage.setItem('paymentStartTime', now.toString());
        }

        // Mostrar el contenedor del temporizador
        paymentTimerContainer.style.display = 'flex';
        
        // Limpiar cualquier intervalo previo
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        timerInterval = setInterval(() => {
            const current = new Date().getTime();
            const remainingTime = endTime - current;
            
            if (remainingTime < 0) {
                clearInterval(timerInterval);
                paymentTimerDisplay.textContent = '00:00';
                paymentTimerContainer.classList.add('expired', 'critical-state'); // Tambi√©n a√±ade critical-state al expirar
                alert(`El tiempo de ${PAYMENT_TIMEOUT_MINUTES} minutos para completar el pago ha expirado. Su carrito ha sido vaciado.`);
                
                // Redirigir y vaciar carrito
                localStorage.removeItem('transactionDetails');
                localStorage.removeItem('cartItems'); 
                localStorage.removeItem('paymentStartTime');
                window.location.href = 'index.html';
                return;
            }

            displayTime(remainingTime);
        }, 1000);
    }
    
    /**
     * ‚è∞ FUNCI√ìN MODIFICADA: Actualiza el texto y **las clases de estado** del temporizador.
     * Esto corrige el problema del color hardcoded.
     * @param {number} ms - Milisegundos restantes.
     */
    function displayTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        
        const minutesStr = minutes < 10 ? '0' + minutes : minutes;
        const secondsStr = seconds < 10 ? '0' + seconds : seconds;
        
        paymentTimerDisplay.textContent = `${minutesStr}:${secondsStr}`;
        
        // **INICIO DE LA CORRECCI√ìN DEL COLOR HARDCODED**
        
        // 1. Limpiar clases de estado previas
        paymentTimerContainer.classList.remove('warning-state', 'critical-state');

        // 2. Aplicar clases basadas en el tiempo restante (Usando las variables CSS)
        if (minutes < 5 && minutes >= 2) {
            // Estado de advertencia (5 minutos o menos, pero m√°s de 1 minuto)
            paymentTimerContainer.classList.add('warning-state');
        } else if (minutes < 2) {
            // Estado cr√≠tico (menos de 2 minutos)
            paymentTimerContainer.classList.add('critical-state');
        } 
        
        // Si el tiempo es mayor a 5 minutos, no se a√±ade ninguna clase, 
        // y el contenedor mantiene su estilo base (que deber√≠a usar --timer-normal-bg)
        
        // **FIN DE LA CORRECCI√ìN DEL COLOR HARDCODED**
    }

    /**
     * @NUEVA_FUNCI√ìN_CLAVE: Busca y retorna el google_id de la transacci√≥n.
     * Esto es CR√çTICO para las recargas de saldo.
     * @returns {string|null} El Google ID si se encuentra un √≠tem de 'Recarga de Saldo', de lo contrario null.
     */
    function getGoogleIdFromTransaction() {
        // Aseguramos que transactionDetails sea un array
        const cartItems = Array.isArray(transactionDetails) ? transactionDetails : (transactionDetails ? [transactionDetails] : []);
        
        for (const item of cartItems) {
            // Buscamos espec√≠ficamente el item de 'Recarga de Saldo' que deber√≠a contener el google_id
            if (item.game === 'Recarga de Saldo' && item.google_id) { 
                return item.google_id;
            }
        }
        return null; 
    }


    /**
     * @NUEVA_FUNCI√ìN: Verifica si alg√∫n √≠tem en la transacci√≥n requiere flujo asistido (TikTok/Telegram).
     * @returns {boolean}
     */
    function isAssistedFlow() {
        // Si no hay detalles, no es asistido
        if (!transactionDetails) return false;

        // Si es un array (carrito), verificamos si ALGUNO de los items es asistido
        if (Array.isArray(transactionDetails)) {
            return transactionDetails.some(item => 
                item.game === "TikTok" || item.game === "Telegram"
            );
        } 
        
        // Si es un objeto singular (flujo antiguo), verificamos ese objeto
        return transactionDetails.game === "TikTok" || transactionDetails.game === "Telegram";
    }

    /**
     * @MODIFICADO: Genera y actualiza el enlace de WhatsApp para recargas asistidas.
     * Ahora genera un mensaje detallado para el carrito.
     */
    function updateWhatsAppLink() {
        if (!isAssistedFlow()) return;

        const whatsappLink = document.querySelector('.whatsapp-link');
        // const email = document.getElementById('email') ? document.getElementById('email').value.trim() : ''; // REMOVIDO
        const whatsappNumber = document.getElementById('whatsappNumber') ? document.getElementById('whatsappNumber').value.trim() : '';
        // const isEmailValid = document.getElementById('email') ? document.getElementById('email').checkValidity() : false; // REMOVIDO
        
        if (whatsappLink && whatsappNumber && transactionDetails && transactionDetails.finalPrice) { // 'email' y 'isEmailValid' REMOVIDOS
            
            let message = `¬°Hola! Quiero confirmar mi pedido de recarga.\n\n*Pedido Asistido:*\n`;
            
            // Determinar si es un solo item o un carrito
            const cartItems = Array.isArray(transactionDetails) ? transactionDetails : (transactionDetails ? [transactionDetails] : []);
            
            let totalAmount = transactionDetails.finalPrice || 'N/A';
            let currency = transactionDetails.currency || 'USD';
            
            // Construcci√≥n del mensaje con los detalles de la transacci√≥n
            cartItems.forEach((item, index) => {
                // Solo listamos los √≠tems que requieran asistencia
                if (item.game === "TikTok" || item.game === "Telegram") {
                    message += `\n*Item ${index + 1}:*\n`;
                    message += `*Juego/Servicio:* ${item.game}\n`;
                    message += `*Paquete:* ${item.packageName}\n`;
                    if (item.playerId) {
                        message += `*ID/Usuario:* ${item.playerId}\n`;
                    } else if (item.robloxEmail) {
                        message += `*Correo:* ${item.robloxEmail}\n`;
                    }
                }
            });
            
            message += `\n*TOTAL A PAGAR:* ${totalAmount} ${currency}`;
            // message += `\n\n*Correo de Contacto:* ${email}\n*WhatsApp de Contacto:* ${whatsappNumber}\n\nPor favor, ay√∫dame a finalizar mi compra.`; // REEMPLAZADO
            message += `\n\n*WhatsApp de Contacto:* ${whatsappNumber}\n\nPor favor, ay√∫dame a finalizar mi compra.`; // Correo no es necesario, se busca en la sesi√≥n

            const encodedMessage = encodeURIComponent(message);
            
            // N√∫mero de WhatsApp de Malok Recargas
            const malokWhatsappNumber = '573021090841'; 
            
            // Ajustar el selector al que est√° en el HTML
            const whatsappLinkInContainer = whatsappMessageContainer.querySelector('.whatsapp-link');
            if (whatsappLinkInContainer) {
                whatsappLinkInContainer.href = `https://wa.me/${malokWhatsappNumber}?text=${encodedMessage}`;
                whatsappLinkInContainer.classList.remove('disabled');
                whatsappLinkInContainer.style.pointerEvents = 'auto'; // Habilitar click
                whatsappLinkInContainer.style.opacity = '1';
            }
        } else if (whatsappLink) {
            // Deshabilitar el enlace si faltan campos o detalles de la transacci√≥n
            const whatsappLinkInContainer = whatsappMessageContainer.querySelector('.whatsapp-link');
            if (whatsappLinkInContainer) {
                whatsappLinkInContainer.href = '#';
                whatsappLinkInContainer.classList.add('disabled');
                whatsappLinkInContainer.style.pointerEvents = 'none'; // Deshabilitar click
                whatsappLinkInContainer.style.opacity = '0.5';
            }
        }
    }

    /**
     * @MODIFICADO: Genera y actualiza el resumen de la transacci√≥n en la UI, ahora manejando un array de productos (el carrito).
     * Calcula el total de todos los productos y muestra los detalles individuales.
     * üéØ FIX: Se a√±ade l√≥gica para manejar el precio USDM (precio base sin recargo) para el c√°lculo del total y la visualizaci√≥n.
     */
    function updateTransactionSummary() {
        const summaryDiv = document.getElementById('transaction-summary');
        
        // Aseguramos que transactionDetails sea un array. Si es un objeto singular (flujo antiguo), lo convertimos a un array.
        const cartItems = Array.isArray(transactionDetails) ? transactionDetails : (transactionDetails ? [transactionDetails] : []);
        
        if (!summaryDiv || cartItems.length === 0) {
            summaryDiv.innerHTML = '<p class="error-message">No se encontraron detalles de la recarga. Por favor, vuelve a la tienda.</p>';
            // ‚è∞ A√ëADIDO: Detener el temporizador si no hay detalles de transacci√≥n v√°lidos
            clearInterval(timerInterval);
            localStorage.removeItem('paymentStartTime');
            
            setTimeout(() => { window.location.href = 'index.html'; }, 1000);
            return;
        }

        // Obtener la moneda seleccionada (VES, USD o USDM)
        const selectedCurrency = localStorage.getItem('selectedCurrency') || 'USD';
        const currencySymbol = selectedCurrency === 'VES' ? 'Bs.S' : '$';

        let totalUSD = 0; // Total con recargo (e.g., $1.13)
        let totalVES = 0;
        let totalUSDM = 0; // üéØ FIX 1: Nuevo total para USDM (Precio base sin recargo, e.g., $1.00)

        let summaryHTML = '<h3>Resumen de la Transacci√≥n</h3>';
        summaryHTML += '<div class="product-list-summary">';

        // 1. Iterar sobre cada item del carrito
        cartItems.forEach((item, index) => {
            // Aseguramos que los precios sean n√∫meros, usando 0 como fallback
            const priceUSD = parseFloat(item.priceUSD || 0);
            const priceVES = parseFloat(item.priceVES || 0);
            // üéØ FIX 2: Usamos un campo para el precio base (USDM). Se asume que el user lo carga como 'priceUSDM' o 'priceBaseUSD'.
            const priceUSDM = parseFloat(item.priceUSDM || item.priceBaseUSD || 0);

            // Acumular todos los totales
            totalUSD += priceUSD;
            totalVES += priceVES;
            totalUSDM += priceUSDM; // üéØ FIX 3: Acumular el total de USDM

            // El precio a mostrar depende de la moneda seleccionada
            let displayPrice;
            if (selectedCurrency === 'VES') {
                displayPrice = priceVES.toFixed(2);
            } else if (selectedCurrency === 'USDM') {
                // üéØ FIX 4: L√≥gica para USDM (usa el precio base)
                // Si el precio USDM no est√° definido (> 0), usa el precio USD (el error original, pero con fallback)
                displayPrice = priceUSDM > 0 ? priceUSDM.toFixed(2) : priceUSD.toFixed(2);
            } else {
                // Por defecto 'USD' (usa el precio con recargo)
                displayPrice = priceUSD.toFixed(2);
            }

            let game = item.game || 'Servicio Desconocido';
            let passwordHtml = '';
            let playerInfoHtml = '';
            let gameOrServiceLabel = 'Juego';
            const passwordToReveal = item.passwordToReveal || null;


            // üéØ CAMBIO CLAVE: Manejar la l√≥gica de Recarga de Saldo/Wallet de forma distinta
            if (game === 'Recarga de Saldo' && item.google_id) {
                // L√≥gica especial para Recarga de Saldo/Wallet
                gameOrServiceLabel = 'Servicio';
                playerInfoHtml = `<p><strong>ID de Usuario (Google ID):</strong> ${item.google_id}</p>`;
            // üéØ FIN DEL CAMBIO
            } else {
                // Para otros juegos, mostramos el ID de Jugador (playerId)
                const playerIdHtml = item.playerId ? `<p><strong>ID/Usuario:</strong> ${item.playerId}</p>` : '';
                playerInfoHtml = playerIdHtml;
            }

            // Generar HTML de la contrase√±a si existe
            if (passwordToReveal) {
                const maskedPassword = '‚Ä¢'.repeat(passwordToReveal.length);
                passwordHtml = `
                    <p><strong>Contrase√±a:</strong> <span id="game-password-${index}">${maskedPassword}</span>
                        <button type="button" class="toggle-password" data-target-id="game-password-${index}" data-password="${passwordToReveal}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </p>
                `;
            }

            // Creamos el HTML para el item actual
            summaryHTML += `
                <div class="product-summary-item" data-index="${index}">
                    <p class="item-name"><strong>${gameOrServiceLabel} (${game}):</strong> ${item.packageName}</p>
                    ${playerInfoHtml}
                    ${passwordHtml}
                    <p class="item-price">Precio: <span class="price-value">${currencySymbol} ${displayPrice}</span></p>
                </div>
                <hr>
            `;
        });

        // 2. Mostrar el Total Final
        // üéØ FIX 5: Determinar el total final basado en la moneda seleccionada, incluyendo USDM
        const finalDisplayTotal = selectedCurrency === 'VES' ? totalVES.toFixed(2) : (selectedCurrency === 'USDM' ? totalUSDM.toFixed(2) : totalUSD.toFixed(2));

        // A√±adimos el contenedor final del total
        summaryHTML += `
            </div>
            <div class="transaction-total">
                <p><strong>TOTAL A PAGAR:</strong> <span id="final-total" data-usd="${totalUSD.toFixed(2)}" data-ves="${totalVES.toFixed(2)}" data-usdm="${totalUSDM.toFixed(2)}">${currencySymbol} ${finalDisplayTotal}</span></p>
            </div>
        `;
        summaryDiv.innerHTML = summaryHTML;

        // 3. Almacenar los totales en la variable global para usar en el pago
        // üéØ FIX 6: Almacenar los totales finales en transactionDetails para asegurar la consistencia.
        if (Array.isArray(transactionDetails)) {
            // Si es un carrito, a√±adimos los totales al primer elemento del array, o a un objeto de totales
            transactionDetails.totalUSD = totalUSD.toFixed(2);
            transactionDetails.totalVES = totalVES.toFixed(2);
            transactionDetails.totalUSDM = totalUSDM.toFixed(2);
            transactionDetails.finalPrice = finalDisplayTotal;
            transactionDetails.currency = selectedCurrency;
        } else if (transactionDetails) {
            // Si es un objeto singular (flujo antiguo), actualizamos el objeto
            transactionDetails.totalUSD = totalUSD.toFixed(2);
            transactionDetails.totalVES = totalVES.toFixed(2);
            transactionDetails.totalUSDM = totalUSDM.toFixed(2);
            transactionDetails.finalPrice = finalDisplayTotal;
            transactionDetails.currency = selectedCurrency;
        } else {
             // Esto no deber√≠a pasar si la comprobaci√≥n inicial fue exitosa, pero por seguridad
             console.error("No se pudieron almacenar los totales en transactionDetails.");
        }
        
        // 4. Actualizar la selecci√≥n de m√©todos de pago
        // üéØ FIX 7: Llamar a esta funci√≥n para que se muestren los radios de pago correctos
        renderPaymentMethods(selectedCurrency); 

        // 5. Agregar listeners para mostrar/ocultar contrase√±as
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.targetId;
                const password = this.dataset.password;
                const targetSpan = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (targetSpan.textContent.includes('‚Ä¢')) {
                    targetSpan.textContent = password;
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    targetSpan.textContent = '‚Ä¢'.repeat(password.length);
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });

        // 6. Si es un flujo asistido, mostrar el contenedor de WhatsApp
        if (isAssistedFlow()) {
            whatsappMessageContainer.style.display = 'block';
            finalizeBtn.style.display = 'none'; // Ocultar el bot√≥n de finalizar si es asistido
            updateWhatsAppLink(); // Inicializar el enlace
        } else {
            whatsappMessageContainer.style.display = 'none';
            finalizeBtn.style.display = 'block';
        }
    }


    /**
     * @NUEVA_FUNCI√ìN: Renderiza las opciones de pago en base a la moneda.
     * üéØ FIX: Se a√±ade l√≥gica para mostrar solo 'Wallet' si la moneda seleccionada es 'USDM'.
     */
    function renderPaymentMethods(currency) {
        paymentMethodsDiv.innerHTML = ''; // Limpiar opciones anteriores
        let methods = [];

        if (currency === 'VES') {
            methods = paymentMethodsVES;
        } else if (currency === 'USDM') { 
            // üéØ L√≥gica para USDM: solo Wallet
            methods = paymentMethodsUSDM;
        } else {
            methods = paymentMethodsUSD; // Por defecto USD
        }

        methods.forEach(method => {
            const methodItem = document.createElement('div');
            methodItem.classList.add('payment-method-option');
            methodItem.innerHTML = `
                <input type="radio" id="method-${method.id}" name="paymentMethod" value="${method.id}" data-type="${method.type}">
                <label for="method-${method.id}">
                    <i class="${method.icon}"></i>
                    <span>${method.name}</span>
                </label>
            `;
            paymentMethodsDiv.appendChild(methodItem);
        });

        paymentMethodsDiv.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const selectedMethodId = event.target.value;
                loadPaymentDetails(selectedMethodId);
                checkFormValidity();
            });
        });

        checkFormValidity();
    }


    /**
     * @MODIFICADO: Carga la plantilla de detalles de pago para el m√©todo seleccionado.
     * @param {string} methodId - ID del m√©todo de pago.
     * üéØ FIX: Se a√±ade l√≥gica especial para el m√©todo 'wallet' para mostrar el precio `totalUSDM`.
     */
    function loadPaymentDetails(methodId) {
        let methodHtml = paymentDetailsTemplates[methodId];
        
        if (methodHtml) {
            paymentDetailsFormDiv.innerHTML = methodHtml;

            // üéØ FIX 8: L√≥gica especial para el m√©todo Wallet, usando totalUSDM.
            if (methodId === 'wallet') {
                const finalPriceElement = document.getElementById('wallet-final-price');
                // Ahora usa el totalUSDm calculado en updateTransactionSummary
                const finalPriceUSDM = transactionDetails.totalUSDM || transactionDetails.priceUSDM;
                if (finalPriceElement) {
                    finalPriceElement.textContent = `$ ${finalPriceUSDM}`;
                }
            }

            const fileInput = document.getElementById('payment-receipt');
            // üõë MODIFICACI√ìN: Solo agregar listener 'change' si es un input de tipo 'file'
            // Tambi√©n ajustar la propiedad 'required' seg√∫n el m√©todo
            if (fileInput) {
                // M√©todos que requieren subir archivo (por defecto)
                if (methodId === 'pago-movil' || methodId === 'zinli') {
                    fileInput.required = true;
                }
                // M√©todos que NO requieren subir archivo o usan hidden input (binance, binance-id, wallet)
                if (methodId === 'binance' || methodId === 'binance-id' || methodId === 'wallet') {
                    fileInput.required = false;
                }
                
                // Si es un input de tipo file, a√±adimos el listener para validar.
                if (fileInput.type === 'file') {
                     fileInput.addEventListener('change', checkFormValidity);
                }
            }
            
            // Agregar listeners para copiar
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    copyToClipboard(e.currentTarget.dataset.copyTarget);
                });
            });

            // Re-chequear la validez por si el m√©todo seleccionado deshabilita el input de archivo
            checkFormValidity();
            
        } else {
            paymentDetailsFormDiv.innerHTML = '<p class="error-message">Selecciona un m√©todo de pago para ver los detalles.</p>';
        }
    }


    /**
     * @NUEVA_FUNCI√ìN: Limpia las variables de sesi√≥n despu√©s de un pago exitoso o asistido.
     */
    function cleanUpPaymentSession() {
        localStorage.removeItem('transactionDetails');
        localStorage.removeItem('cartItems'); 
        localStorage.removeItem('paymentStartTime');
        
        // Detener el intervalo del temporizador si est√° activo
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        paymentTimerContainer.style.display = 'none'; // Ocultar el temporizador
    }


    /**
     * Funci√≥n gen√©rica para copiar al portapapeles.
     * @param {string} targetId - ID del elemento que contiene el texto a copiar.
     */
    function copyToClipboard(targetId) {
        const targetElement = document.getElementById(targetId);
        const feedbackElement = document.getElementById(`${targetId}-copy-feedback`);
        
        if (targetElement) {
            // Crear un √°rea de texto temporal para la copia
            const tempInput = document.createElement('input');
            tempInput.value = targetElement.textContent.trim();
            document.body.appendChild(tempInput);
            
            // Seleccionar y copiar
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // Para m√≥viles
            
            try {
                document.execCommand('copy');
                
                if (feedbackElement) {
                    feedbackElement.textContent = '¬°Copiado!';
                    feedbackElement.style.display = 'inline';
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 2000);
                }
            } catch (err) {
                console.error('Error al intentar copiar:', err);
                alert('Tu navegador no soporta la copia autom√°tica o no se encontr√≥ el elemento. Por favor, selecciona y copia la direcci√≥n manualmente.');
            }
            
            // Eliminar el √°rea de texto temporal
            document.body.removeChild(tempInput);

        } else {
            alert('Tu navegador no soporta la copia autom√°tica o no se encontr√≥ el elemento. Por favor, selecciona y copia la direcci√≥n manualmente.');
        }
    }

    /**
     * @MODIFICADO: Verifica la validez del formulario y habilita/deshabilita los botones.
     * Ahora incluye la excepci√≥n para 'binance', 'binance-id' y 'wallet'.
     *
     * ‚ùå CAMBIO CLAVE: Se eliminan las validaciones de email.
     */
    function checkFormValidity() {
        const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
        const isMethodSelected = selectedRadio !== null;
        const selectedMethodId = selectedRadio ? selectedRadio.value : null; // Obtener el ID seleccionado
        
        // const emailInput = document.getElementById('email'); // REMOVIDO
        const whatsappInput = document.getElementById('whatsappNumber');
        
        // const isEmailFilled = emailInput && emailInput.value.trim() !== ''; // REMOVIDO
        // const isEmailValid = emailInput && emailInput.checkValidity(); // REMOVIDO
        const isWhatsappFilled = whatsappInput && whatsappInput.value.trim() !== '';

        let areDetailsFilled = true;

        if (isAssistedFlow()) {
            // Flujo asistido
            areDetailsFilled = true;
        } else if (selectedMethodId === 'binance') {
            // Plisio (Redirecci√≥n autom√°tica)
            areDetailsFilled = true;
        } else if (selectedMethodId === 'wallet') {
            // üéØ Wallet
            areDetailsFilled = true;
        } else if (selectedMethodId === 'binance-id') {
            // üÜï Binance ID (Comprobante opcional)
            areDetailsFilled = true;
        } else if (isMethodSelected) {
            // Otros m√©todos (Pago Movil/Zinli): Requieren archivo
            const fileInput = document.getElementById('payment-receipt');
            if (fileInput && fileInput.files.length === 0) {
                areDetailsFilled = false;
            }
        } else {
            areDetailsFilled = false; // Debe seleccionar un m√©todo
        }

        // L√≥gica para el bot√≥n de FINALIZAR RECARGA (flujo normal)
        if (!isAssistedFlow()) {
             // ‚ùå isEmailFilled y isEmailValid REMOVIDOS
            if (isMethodSelected && isWhatsappFilled && areDetailsFilled) { 
                finalizeBtn.disabled = false;
            } else {
                finalizeBtn.disabled = true;
            }
        } 
        
        // L√≥gica para el enlace de WhatsApp (flujo asistido)
        if (isAssistedFlow()) {
            // ‚ùå isEmailFilled y isEmailValid REMOVIDOS
            if (isWhatsappFilled) { 
                // Si todos los datos est√°n llenos, actualizamos y habilitamos el enlace de WhatsApp
                updateWhatsAppLink();
            } else {
                // Si falta el n√∫mero de WhatsApp, deshabilitamos el enlace (ya se encarga updateWhatsAppLink)
                updateWhatsAppLink(); 
            }
        }

        // Listener para el input de WhatsApp (siempre)
        if (whatsappInput) {
            whatsappInput.removeEventListener('input', checkFormValidity);
            whatsappInput.addEventListener('input', checkFormValidity);
        }
    }


    // 4. INICIALIZACI√ìN
    document.addEventListener('DOMContentLoaded', () => {
        // üîê NUEVA L√ìGICA: Verificar sesi√≥n antes de cargar la p√°gina de pago
        if (!checkActiveSession()) {
             // Si checkActiveSession retorna false, ya redirigi√≥, as√≠ que detenemos el resto del script
             return; 
        }

        // üü¢ NUEVA L√ìGICA: DETECCI√ìN DE REDIRECCI√ìN DE PLISIO (FLUSO AUTOM√ÅTICO)
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');

        // üõë ELEMENTOS A OCULTAR
        const h2Title = document.querySelector('.form-container h2');
        const transactionSummary = document.getElementById('transaction-summary');

        if (status === 'success' || status === 'processing') {
            // A√±adido 'processing' como estado de redirecci√≥n
            console.log('Detectada redirecci√≥n de Plisio exitosa. Activando mensaje de procesamiento.');
            
            // üõë L√çNEAS A√ëADIDAS PARA OCULTAR ELEMENTOS
            if (h2Title) h2Title.style.display = 'none';
            if (transactionSummary) transactionSummary.style.display = 'none';
            // üõë FIN NUEVAS L√çNEAS
            
            // 1. Ocultar el formulario de comprobante de pago
            if (paymentForm) paymentForm.style.display = 'none';
            // 2. Ocultar la secci√≥n de mensaje de WhatsApp (si existe)
            if (whatsappMessageContainer) whatsappMessageContainer.style.display = 'none';
            // 3. Mostrar el mensaje de √©xito (el cuadro de "Su recarga est√° siendo procesada...")
            if (successMessageDisplay) successMessageDisplay.style.display = 'block';
            
            // 4. Limpiar la sesi√≥n de pago
            cleanUpPaymentSession(); // ‚è∞ USAR LA NUEVA FUNCI√ìN
            
            // 5. Iniciar la redirecci√≥n autom√°tica a index.html despu√©s de 5 segundos
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 5000);
            
            // üõë Detener la ejecuci√≥n del resto del script
            return;
        }
        // üõë FIN DE NUEVA L√ìGICA DE PLISIO

        const storedDetails = localStorage.getItem('transactionDetails');
        if (storedDetails) {
            transactionDetails = JSON.parse(storedDetails);

            // ‚è∞ INICIO DEL TEMPORIZADOR: Solo si hay detalles de transacci√≥n v√°lidos
            startPaymentTimer(); 
            // ----------------------------------------------------

            // APLICAR ARREGLO CLAVE: Si es un objeto singular (flujo antiguo) Y no contiene la clave 'length',
            // lo envolvemos en un array para que la l√≥gica de carrito funcione correctamente.
            if (transactionDetails && !Array.isArray(transactionDetails)) {
                // Verificamos si es un objeto con la estructura de un solo item, pero no es array.
                // Si tiene 'game', es un item singular.
                if (transactionDetails.game) {
                     transactionDetails = [transactionDetails];
                     // Actualizar el localStorage con el nuevo formato de array para evitar re-procesamiento
                     localStorage.setItem('transactionDetails', JSON.stringify(transactionDetails));
                } else {
                     // Si es un objeto vac√≠o o con estructura inv√°lida, lo tratamos como error.
                     transactionDetails = [];
                }
            }


            updateTransactionSummary();

            // Cargar por defecto el primer m√©todo de la lista si hay una moneda seleccionada.
            // Esto solo se hace si NO es un flujo asistido (ya que no necesita m√©todo de pago)
            if (!isAssistedFlow()) {
                const selectedCurrency = localStorage.getItem('selectedCurrency') || 'USD';
                let methodsToLoad = [];

                if (selectedCurrency === 'VES') {
                    methodsToLoad = paymentMethodsVES;
                } else if (selectedCurrency === 'USDM') {
                    methodsToLoad = paymentMethodsUSDM;
                } else {
                    methodsToLoad = paymentMethodsUSD;
                }

                if (methodsToLoad.length > 0) {
                    const defaultMethod = methodsToLoad[0].id;
                    // Seleccionar el radio button por defecto
                    const defaultRadio = document.getElementById(`method-${defaultMethod}`);
                    if (defaultRadio) {
                        defaultRadio.checked = true;
                        loadPaymentDetails(defaultMethod);
                    }
                }
            } else {
                 // Si es asistido, el resumen ya se encarg√≥ de ocultar el bot√≥n de finalizar 
                 // y mostrar el enlace de whatsapp (si no es asistido)
            }
            
        } else {
            transactionSummaryDiv.innerHTML = '<p>No se encontraron detalles de la transacci√≥n. Por favor, regresa a la p√°gina de inicio.</p>';
            finalizeBtn.style.display = 'none';
            whatsappMessageContainer.style.display = 'none';
            if (paymentDetailsFormDiv) paymentDetailsFormDiv.style.display = 'none';
            if (paymentMethodsDiv) paymentMethodsDiv.closest('.form-section-step').style.display = 'none';
            
            // ‚è∞ A√ëADIDO: Detener el temporizador si no hay detalles de transacci√≥n v√°lidos
            clearInterval(timerInterval);
            localStorage.removeItem('paymentStartTime');
            paymentTimerContainer.style.display = 'none';
        }
    });

    document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(paymentForm);
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        
        // const emailInput = document.getElementById('email'); // REMOVIDO
        const whatsappInput = document.getElementById('whatsappNumber');

        // ‚ùå Eliminadas validaciones de correo electr√≥nico
        if (!whatsappInput || whatsappInput.value.trim() === '') {
            alert('Por favor, ingresa tu n√∫mero de WhatsApp para poder contactarte y completar la recarga.');
            return;
        }

        // L√≥gica especial para recargas asistidas (no se env√≠an al backend)
        if (isAssistedFlow()) {
            // üõë L√çNEAS A√ëADIDAS PARA OCULTAR ELEMENTOS
            const h2Title = document.querySelector('.form-container h2');
            const transactionSummary = document.getElementById('transaction-summary');
            if (h2Title) h2Title.style.display = 'none';
            if (transactionSummary) transactionSummary.style.display = 'none';
            // üõë FIN NUEVAS L√çNEAS
            
            // Simplemente oculta el formulario y muestra el mensaje de √©xito temporal.
            paymentForm.style.display = 'none';
            whatsappMessageContainer.style.display = 'none';
            successMessageDisplay.style.display = 'block';
            
            cleanUpPaymentSession(); // ‚è∞ USAR LA NUEVA FUNCI√ìN
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 5000);
            
            return;
        }
        
        // üéØ FIX 9: Obtener el precio final correcto (USDM si es Wallet, USD si es Binance, o el de la transacci√≥n)
        const finalPriceUSD = selectedPaymentMethod === 'wallet' 
            ? transactionDetails.totalUSDM 
            : transactionDetails.totalUSD;
            
        if (!finalPriceUSD || parseFloat(finalPriceUSD) <= 0) {
            alert('Error: El monto de la transacci√≥n es inv√°lido. Por favor, revisa tu carrito.');
            return;
        }


        // üéØ CAMBIO CLAVE: L√≥gica para el flujo de pago con Wallet
        if (selectedPaymentMethod === 'wallet') {
            const sessionToken = localStorage.getItem(SESSION_TOKEN_KEY);
            
            if (!sessionToken) {
                alert('Error de sesi√≥n. Por favor, vuelve a iniciar sesi√≥n para usar la Wallet.');
                window.location.href = LOGIN_PAGE_URL;
                return;
            }
            
            // üõë DIAGN√ìSTICO CLAVE 1: Estado inicial de la transacci√≥n
            console.log(`DIAGN√ìSTICO: Pago con Wallet seleccionado. Precio USDM: ${finalPriceUSD}`);

            finalizeBtn.disabled = true;
            finalizeBtn.textContent = 'Deduciendo Saldo...';
            
            // üõë DIAGN√ìSTICO CLAVE 2: Antes de la llamada de red
            console.log(`DIAGN√ìSTICO: Iniciando fetch a Netlify Function '/.netlify/functions/deduct-wallet-balance' con Token Bearer. Monto: ${finalPriceUSD}`);

            try {
                // 1. PAGO: Llamada a deduct-wallet-balance
                const walletResponse = await fetch('/.netlify/functions/deduct-wallet-balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        // email: emailInput.value.trim(), // ‚ùå REMOVIDO: Se busca en el backend.
                        whatsapp: whatsappInput.value.trim(),
                        amountUSD: finalPriceUSD, // Usamos finalPriceUSD (que es el totalUSDM)
                        cartDetails: JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]),
                    })
                });
                
                // üõë DIAGN√ìSTICO CLAVE 3: Despu√©s de la respuesta de red
                console.log('DIAGN√ìSTICO: Respuesta de Netlify Function recibida. Estado:', walletResponse.status);

                if (walletResponse.ok) {
                    // 2. √âXITO EN EL PAGO: Ahora llamar a process-payment (Notificaci√≥n a Telegram)
                    finalizeBtn.textContent = 'Enviando Notificaci√≥n...';
                    console.log('DIAGN√ìSTICO: Deducci√≥n exitosa. Procediendo a notificar el pago.');
                    
                    // üîë L√çNEA CLAVE A√ëADIDA: Refrescar el saldo despu√©s de una deducci√≥n exitosa
                    window.refreshWalletBalance(); 

                    // a. Preparar FormData para la funci√≥n process-payment (simulando formulario)
                    const processFormData = new FormData();
                    processFormData.append('paymentMethod', 'wallet');
                    // processFormData.append('email', emailInput.value.trim()); // ‚ùå REMOVIDO
                    processFormData.append('whatsappNumber', whatsappInput.value.trim());
                    // Enviamos la cadena de valor del input hidden
                    processFormData.append('paymentReceipt', 'Wallet_Deduction_Flow');
                    
                    // A√±adir todos los datos de la transacci√≥n al FormData para process-payment
                    processFormData.append('cartDetails', JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]));
                    
                    // üéØ FIX 10: Asegurarnos de enviar los totales correctos para la notificaci√≥n
                    processFormData.append('finalPrice', finalPriceUSD); 
                    processFormData.append('currency', 'USDM'); // Moneda de la Wallet
                    processFormData.append('totalUSD', transactionDetails.totalUSD); 
                    processFormData.append('totalVES', transactionDetails.totalVES); 
                    processFormData.append('totalUSDM', finalPriceUSD);

                    // b. Llamar a process-payment para la notificaci√≥n
                    const notificationResponse = await fetch('/.netlify/functions/process-payment', {
                        method: 'POST',
                        body: processFormData
                    });

                    if (notificationResponse.ok) {
                        finalizeBtn.textContent = '¬°Recarga Finalizada!';
                        paymentForm.style.display = 'none';
                        successMessageDisplay.style.display = 'block';
                        
                        cleanUpPaymentSession(); // Limpiar sesi√≥n
                        
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 5000);
                        
                    } else {
                        // 2.1. √âXITO EN DEDUCCI√ìN, PERO FALLO EN NOTIFICACI√ìN
                        // Esto es cr√≠tico, pero el pago ya se hizo. Notificamos al usuario del error de *notificaci√≥n*.
                        const errorData = await notificationResponse.json();
                        alert(`Pago realizado con √©xito, pero fall√≥ la notificaci√≥n autom√°tica. Guarda tu comprobante. Error: ${errorData.message}`);
                        console.error('DIAGN√ìSTICO: Notification error (Status:', notificationResponse.status, '):', errorData);
                        
                        finalizeBtn.textContent = 'Notificaci√≥n Fallida';
                        paymentForm.style.display = 'none';
                        successMessageDisplay.style.display = 'block'; // Mostrar mensaje de √©xito a pesar del fallo de notificaci√≥n
                        
                        cleanUpPaymentSession(); // Limpiar sesi√≥n
                        
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 5000);
                    }


                } else {
                    // 2. PAGO FALLIDO (Deducci√≥n fallida/Saldo insuficiente)
                    const errorData = await walletResponse.json();
                    const errorMessage = errorData.message || 'Error desconocido';
                    
                    if (errorMessage.toLowerCase().includes('saldo insuficiente') || errorMessage.toLowerCase().includes('monto supera los limites de fondos')) {
                        alert('El monto de la recarga supera el saldo disponible en tu Wallet. Por favor, recarga tu billetera o selecciona otro m√©todo de pago.');
                    } else {
                        alert(`Error en el pago con Wallet: ${errorMessage}.`);
                    }
                    
                    console.error('DIAGN√ìSTICO: Wallet deduction error (Status:', walletResponse.status, '):', errorData);
                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = 'Finalizar Recarga';
                }

            } catch (error) {
                // üõë DIAGN√ìSTICO CLAVE 4: Error de red o promesa fallida
                alert('Hubo un problema de conexi√≥n al intentar pagar con Wallet. Revisa la consola para el error de red.');
                console.error('DIAGN√ìSTICO: Wallet network error:', error);
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
            }
            
            return;
        }
        // üéØ FIN DEL CAMBIO CLAVE: L√≥gica para el flujo de pago con Wallet

        // üõë L√≥gica para el flujo de pago con Plisio (M√©todo Binance de redirecci√≥n)
        if (selectedPaymentMethod === 'binance') {
            // L√≥gica de validaci√≥n: Usa finalPriceUSD (que ahora contiene el precio USD con recargo si no es 'wallet')
            if (!finalPriceUSD || parseFloat(finalPriceUSD) <= 0) {
                alert('Error: El monto de la transacci√≥n es inv√°lido. Por favor, revisa tu carrito.');
                return;
            }

            finalizeBtn.disabled = true;
            finalizeBtn.textContent = 'Creando Factura en Plisio...';

            const googleIdToSend = getGoogleIdFromTransaction();

            // üéØ FIX 11: A√±adir todos los totales al objeto de la pasarela
            const transactionData = {
                amount: finalPriceUSD, // Monto a pagar (con recargo)
                currency: 'USD',
                // email: emailInput.value.trim(), // ‚ùå REMOVIDO
                whatsapp: whatsappInput.value.trim(),
                googleId: googleIdToSend, // Solo si es recarga de saldo/wallet
                cartDetails: JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]),
                // üéØ A√±adir todos los totales para la metadata de la factura de Plisio
                totalUSD: transactionDetails.totalUSD, 
                totalVES: transactionDetails.totalVES, 
                totalUSDM: transactionDetails.totalUSDM,
            };

            try {
                // Llamar a la Netlify Function que crea la factura en Plisio
                const response = await fetch('/.netlify/functions/create-plisio-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Redirigir al usuario a la URL de pago de Plisio
                    window.location.href = data.redirectUrl; 
                } else {
                    const errorData = await response.json();
                    alert(`Error al crear la factura de Plisio: ${errorData.message}`);
                    console.error('Error creating Plisio charge:', errorData);
                }
            } catch (error) {
                alert('Hubo un problema de conexi√≥n al intentar crear la factura.');
                console.error('Network or client error:', error);
            } finally {
                // Si falla, restaurar el temporizador (asumiendo que el usuario vuelve a la p√°gina)
                startPaymentTimer();
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
            }
            
            return;
        }

        // L√≥gica para flujo de pago normal (requiere comprobante o ID - Pago M√≥vil/Zinli/Binance ID)
        let requiresReceipt = (selectedPaymentMethod === 'pago-movil' || selectedPaymentMethod === 'zinli');
        
        if (requiresReceipt) {
            const paymentReceipt = document.getElementById('payment-receipt');
            if (!paymentReceipt || paymentReceipt.files.length === 0) {
                alert('Por favor, sube tu comprobante de pago.');
                return;
            }
        }
        
        // Agregamos todos los datos de transacci√≥n
        formData.append('cartDetails', JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]));
        
        if (transactionDetails.finalPrice) {
            formData.append('finalPrice', transactionDetails.finalPrice);
            formData.append('currency', transactionDetails.currency);
            formData.append('totalUSD', transactionDetails.totalUSD);
            formData.append('totalVES', transactionDetails.totalVES);
            formData.append('totalUSDM', transactionDetails.totalUSDM); // üéØ FIX 12: Agregar totalUSDM al formData
        }

        console.log("Enviando datos a process-payment.js...");
        finalizeBtn.disabled = true;
        finalizeBtn.textContent = 'Enviando Solicitud...';
        
        try {
            // üéØ Endpoint real
            const response = await fetch('/.netlify/functions/process-payment', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // √âxito en la solicitud, ahora mostramos el mensaje de √©xito
                paymentForm.style.display = 'none';
                successMessageDisplay.style.display = 'block';

                cleanUpPaymentSession(); // Limpiar sesi√≥n
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);

            } else {
                const errorData = await response.json();
                alert(`Error al procesar el pago: ${errorData.message}`);
                console.error('Error del servidor:', errorData);

                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
            }
        } catch (error) {
            alert('Hubo un problema de conexi√≥n al intentar enviar la solicitud.');
            console.error('Error de red o cliente:', error);
            
            finalizeBtn.disabled = false;
            finalizeBtn.textContent = 'Finalizar Recarga';
        }
    });

    // üö© INICIO DE LA MODIFICACI√ìN SOLICITADA üö©
    /**
     * @NUEVA_FUNCI√ìN: Listener que se dispara cuando el usuario intenta navegar fuera de la p√°gina.
     * Su objetivo es limpiar la sesi√≥n de pago (carrito, transaccion y temporizador)
     * a menos que se haya completado el pago o se est√© redirigiendo a login.html.
     */
    window.addEventListener('unload', function (e) {
        // Verificar si el mensaje de √©xito ya se mostr√≥. Si es as√≠, no limpiamos.
        const paymentCompleted = successMessageDisplay.style.display === 'block';

        // üö® CAMBIO CLAVE: Comprobar si existe una redirecci√≥n pendiente hacia el login.
        // Si 'redirectAfterLogin' existe, significa que la navegaci√≥n a login.html fue intencional
        // y NO debemos borrar 'transactionDetails' ni 'cartItems'.
        const isRedirectingToLogin = localStorage.getItem('redirectAfterLogin') !== null;

        // Solo borra el carrito y la transacci√≥n si NO se ha completado el pago Y NO estamos redirigiendo intencionalmente a login.
        if (!paymentCompleted && !isRedirectingToLogin) {
            // Vac√≠a las claves que guardan el estado de la transacci√≥n y el temporizador.
            localStorage.removeItem('transactionDetails'); // Vac√≠a los detalles de la transacci√≥n
            localStorage.removeItem('cartItems'); // Vac√≠a el carrito
            localStorage.removeItem('paymentStartTime'); // Reinicia el contador/temporizador
            
            // Detener el intervalo del temporizador si est√° activo
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            console.log("Sesi√≥n de pago incompleta limpiada debido a navegaci√≥n fuera de la p√°gina.");
        } else if (paymentCompleted) {
             // L√≥gica de limpieza solo de temporizador si el pago ya se complet√≥ (ej. Plisio/Wallet)
             if (timerInterval) {
                clearInterval(timerInterval);
                localStorage.removeItem('paymentStartTime');
             }
             // Las otras claves (cartItems, transactionDetails) ya se limpiaron en el flujo de √©xito
        }
    });

    // üö© FIN DE LA MODIFICACI√ìN SOLICITADA üö©

</script>
</body>
</html>